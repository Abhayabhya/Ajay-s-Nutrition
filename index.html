<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajay's Nutrition - Fuel Your Ambition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        #promotional-banner {
            background-size: 200% auto;
            animation: animated-gradient 6s ease-infinite;
        }
        body {
            font-family: 'Poppins', sans-serif;
            scroll-behavior: smooth;
            background-color: #0f172a; /* Cooler slate background */
        }
        /* Hide scrollbar for cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Dropdown styling */
        .dropdown:hover .dropdown-menu { display: block; }

        /* Star rating styling */
        .star-rating-input { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
        .star-rating-input input { display: none; }
        .star-rating-input label { color: #475569; cursor: pointer; font-size: 2.5rem; transition: color 0.2s, transform 0.2s; }
        .star-rating-input label:hover { transform: scale(1.1); }
        .star-rating-input input:checked ~ label,
        .star-rating-input label:hover,
        .star-rating-input label:hover ~ label { color: #06b6d4; } /* Cyan color for stars */
        
        /* Custom Select Arrow */
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2306b6d4' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* --- KEYFRAME ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideOutRight { from { transform: translateX(0); } to { transform: translateX(100%); } }
        @keyframes hero-glow {
            0% { box-shadow: 0 0 8px #06b6d4, 0 0 16px #06b6d4; }
            100% { box-shadow: 0 0 16px #06b6d4, 0 0 32px #06b6d4; }
        }
        @keyframes scroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes slowZoom {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        @keyframes animated-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes promotional-scroll {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }

        /* --- INTERACTIVE & ANIMATED CLASSES --- */
        .animate-on-scroll { opacity: 0; transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .fade-in-up { transform: translateY(30px); }
        .is-visible { opacity: 1; transform: translateY(0); }
        
        #hero img {
            animation: slowZoom 20s ease-in-out infinite alternate;
        }
        
        .hero-cta-btn { animation: hero-glow 2.5s infinite alternate; }
        
        .interactive-glow:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
        }
        .product-card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .product-card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), 0 0 25px rgba(6, 182, 212, 0.3);
            border-color: #06b6d4;
        }

        /* General Transitions */
        a, button, input, select, textarea { transition: all 0.3s ease-in-out; }
        button:hover { 
            filter: brightness(1.1); 
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0px) scale(0.98);
            filter: brightness(1);
        }

        /* Header & Nav */
        header nav a { position: relative; }
        header nav a::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            bottom: -4px;
            left: 0;
            background-image: linear-gradient(to right, #2dd4bf, #06b6d4);
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.25s ease-out;
        }
        header nav a:hover::after { transform: scaleX(1); transform-origin: bottom left; }

        /* Cart Sidebar */
        #cart-sidebar.open { animation: slideInRight 0.4s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        #cart-sidebar.closed { animation: slideOutRight 0.4s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94); }

        /* Filter Buttons */
        .category-btn.active, .size-btn.active {
            background-image: linear-gradient(to right, #2dd4bf, #06b6d4);
            color: #0f172a;
            border-color: transparent;
        }
        
        /* Accordions */
        .info-accordion-answer, .faq-answer { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; }
        .faq-icon { transition: transform 0.3s ease-in-out; }

        /* Form elements */
        input:focus, select:focus, textarea:focus {
            box-shadow: 0 0 0 2px #0f172a, 0 0 0 4px #06b6d4;
            border-color: #06b6d4;
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(to right, #22d3ee, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Marquee/Ticker Styles */
        .marquee { overflow: hidden; position: relative; width: 100%; }
        .marquee-track { display: flex; width: fit-content; animation: scroll 30s linear infinite; }
        .marquee-track:hover { animation-play-state: paused; }
        .marquee-item { flex-shrink: 0; display: flex; align-items: center; margin: 0 2rem; white-space: nowrap; }

        /* Promotional Banner Marquee */
        .promotional-marquee-track {
            animation: promotional-scroll 20s linear infinite;
        }

        /* Skeleton Loader Styles */
        .skeleton-card {
            background-color: #1e293b;
            border-radius: 0.5rem;
            padding: 1.5rem;
            width: 100%;
        }
        .skeleton-card .shimmer-bg {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #1e293b 8%, #334155 18%, #1e293b 33%);
            background-size: 2000px 104px;
            border-radius: 0.25rem;
        }
        .skeleton-card .h-48 { height: 12rem; }
        .skeleton-card .h-6 { height: 1.5rem; margin-top: 1rem; width: 75%; }
        .skeleton-card .h-4 { height: 1rem; margin-top: 0.5rem; }
        .skeleton-card .w-1-3 { width: 33.33%; }
        .skeleton-card .w-1-2 { width: 50%; }
        .skeleton-card .h-8 { height: 2rem; margin-top: 1rem; width: 25%; }

        /* Category Card Styles */
        .category-photo-card { position: relative; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .category-photo-card:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(6, 182, 212, 0.2); }
        .category-photo-card img { transition: transform 0.3s ease; }
        .category-photo-card:hover img { transform: scale(1.1); }
        .category-photo-card .overlay-text { transition: transform 0.3s ease; }
        .category-photo-card:hover .overlay-text { transform: scale(1.1); }

        /* Loading Overlay */
        #loading-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        #loading-overlay .spinner {
            border-top-color: #06b6d4;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">
    
    <div id="promotional-banner" class="hidden bg-gradient-to-r from-cyan-500 to-teal-400 text-gray-900 font-semibold p-3 overflow-hidden whitespace-nowrap">
        <div class="promotional-marquee-track inline-block">
            <span id="banner-text-content" class="px-12"></span>
            <span id="banner-text-content-clone" class="px-12"></span>
        </div>
    </div>

    <div id="shop-view">
        <header id="home" class="bg-slate-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-slate-800">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between gap-4">
                    <a href="#home" class="flex items-center flex-shrink-0">
                        <img src="logo.png" alt="Ajay's Nutrition Logo" class="h-12 w-auto mr-2" onerror="this.onerror=null;this.src='https://placehold.co/180x48/0f172a/06b6d4?text=Ajay\\\'s+Nutrition';">
                        <span class="text-3xl font-bold gradient-text">Ajay's Nutrition</span>
                    </a>
                    <div class="relative w-full max-w-xs hidden md:block">
                        <input type="text" id="search-bar" placeholder="Search products..." class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:outline-none">
                        <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                    </div>
                    <div class="flex items-center">
                        <nav class="hidden lg:flex items-center space-x-6 mr-6">
                            <a href="#featured-products" class="text-slate-300 hover:text-white transition duration-300">Featured</a>
                            <a href="#products" class="text-slate-300 hover:text-white transition duration-300">Products</a>
                            <a href="#about" class="text-slate-300 hover:text-white transition duration-300">About Us</a>
                            <a href="#contact" class="text-slate-300 hover:text-white transition duration-300">Contact</a>
                            <a href="#faq" class="text-slate-300 hover:text-white transition duration-300">FAQ</a>
                             <div id="auth-links-desktop">
                                <a href="#" id="my-orders-link" class="text-slate-300 hover:text-white transition duration-300">My Orders</a>
                            </div>
                        </nav>
                        <div id="user-account-area" class="flex items-center gap-4">
                            </div>
                        <button id="cart-button" class="relative text-slate-300 hover:text-white transition duration-300 ml-4">
                            <i data-lucide="shopping-cart"></i>
                            <span id="cart-count" class="absolute -top-2 -right-2 bg-cyan-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                        </button>
                        <button id="mobile-menu-button" class="lg:hidden text-slate-300 hover:text-white ml-4">
                           <i data-lucide="menu"></i>
                        </button>
                    </div>
                </div>
                 <div id="mobile-menu" class="hidden lg:hidden mt-4">
                    <div class="relative w-full my-4 md:hidden">
                        <input type="text" id="mobile-search-bar" placeholder="Search products..." class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:outline-none">
                        <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                    </div>
                    <a href="#featured-products" class="mobile-menu-link block py-2 px-4 text-sm text-slate-300 hover:bg-slate-800 rounded">Featured</a>
                    <a href="#products" class="mobile-menu-link block py-2 px-4 text-sm text-slate-300 hover:bg-slate-800 rounded">Products</a>
                    <a href="#about" class="mobile-menu-link block py-2 px-4 text-sm text-slate-300 hover:bg-slate-800 rounded">About Us</a>
                    <a href="#contact" class="mobile-menu-link block py-2 px-4 text-sm text-slate-300 hover:bg-slate-800 rounded">Contact</a>
                    <a href="#faq" class="mobile-menu-link block py-2 px-4 text-sm text-slate-300 hover:bg-slate-800 rounded">FAQ</a>
                    <div id="auth-links-mobile">
                         <a href="#" id="mobile-my-orders-link" class="mobile-menu-link block py-2 px-4 text-sm text-slate-300 hover:bg-slate-800 rounded">My Orders</a>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <section id="hero" class="relative bg-slate-800 text-white text-center py-24 md:py-40 flex items-center justify-center overflow-hidden">
                <div class="absolute inset-0 bg-slate-900 opacity-60 z-0">
                     <img src="https://images.unsplash.com/photo-1581009146145-b5ef050c2e1e?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover" alt="Fitness enthusiast">
                </div>
                <div class="absolute inset-0 bg-gradient-to-b from-slate-900 via-transparent to-slate-900"></div>
                <div class="container mx-auto px-6 relative z-10">
                    <h1 class="text-4xl md:text-6xl font-extrabold text-white leading-tight mb-4 animate-on-scroll fade-in-up">Fuel Your <span class="gradient-text">Ambition</span></h1>
                    <p class="text-lg md:text-xl text-slate-300 max-w-3xl mx-auto mb-8 animate-on-scroll fade-in-up" style="animation-delay: 0.2s;">100% genuine, lab-tested supplements at fair prices. We power your performance, guaranteed.</p>
                    <a href="#products" class="hero-cta-btn inline-block bg-gradient-to-r from-cyan-500 to-teal-400 hover:from-cyan-600 hover:to-teal-500 text-gray-900 font-bold py-3 px-8 rounded-full text-lg transition duration-300 animate-on-scroll fade-in-up" style="animation-delay: 0.4s;">Shop Now</a>
                </div>
            </section>
            
            <section class="bg-slate-800 border-y border-slate-700 py-3">
                <div class="marquee">
                    <div class="marquee-track">
                        <div class="marquee-item"><i data-lucide="truck" class="w-5 h-5 text-cyan-400 mr-3"></i><span class="font-medium text-slate-200">Pan India Delivery</span></div>
                        <div class="marquee-item"><i data-lucide="shield-check" class="w-5 h-5 text-cyan-400 mr-3"></i><span class="font-medium text-slate-200">100% Authentic Products</span></div>
                        <div class="marquee-item"><i data-lucide="refresh-cw" class="w-5 h-5 text-cyan-400 mr-3"></i><span class="font-medium text-slate-200">7 Days Easy Return</span></div>
                        
                        <div class="marquee-item"><i data-lucide="truck" class="w-5 h-5 text-cyan-400 mr-3"></i><span class="font-medium text-slate-200">Pan India Delivery</span></div>
                        <div class="marquee-item"><i data-lucide="shield-check" class="w-5 h-5 text-cyan-400 mr-3"></i><span class="font-medium text-slate-200">100% Authentic Products</span></div>
                        <div class="marquee-item"><i data-lucide="refresh-cw" class="w-5 h-5 text-cyan-400 mr-3"></i><span class="font-medium text-slate-200">7 Days Easy Return</span></div>
                    </div>
                </div>
            </section>

            <section id="shop-by-category" class="py-20 bg-slate-900 pt-12">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-16 animate-on-scroll fade-in-up">
                        <h2 class="text-3xl md:text-5xl font-bold text-white">Shop by Category</h2>
                        <p class="text-slate-400 mt-4 max-w-2xl mx-auto">Find the perfect supplement for your fitness goals.</p>
                        <div class="w-24 h-1 bg-gradient-to-r from-cyan-500 to-teal-400 mx-auto mt-6 rounded"></div>
                    </div>
                    <div id="category-card-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        </div>
                </div>
            </section>

            <section id="featured-products" class="py-20 bg-slate-800/50">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-16 animate-on-scroll fade-in-up">
                        <h2 class="text-3xl md:text-5xl font-bold text-white">Featured Products</h2>
                        <p class="text-slate-400 mt-4 max-w-2xl mx-auto">Handpicked selections, trusted by athletes.</p>
                        <div class="w-24 h-1 bg-gradient-to-r from-cyan-500 to-teal-400 mx-auto mt-6 rounded"></div>
                    </div>
                    <div id="featured-product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                        </div>
                </div>
            </section>

            <section id="products" class="py-20 bg-slate-900">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-16 animate-on-scroll fade-in-up">
                        <h2 class="text-3xl md:text-5xl font-bold text-white">All Products</h2>
                        <p class="text-slate-400 mt-4 max-w-2xl mx-auto">Explore our curated selection of genuine, high-performance supplements.</p>
                        <div class="w-24 h-1 bg-gradient-to-r from-cyan-500 to-teal-400 mx-auto mt-6 rounded"></div>
                    </div>
                     <div class="flex flex-col md:flex-row justify-center md:justify-between items-center gap-4 mb-12 animate-on-scroll fade-in-up">
                         <div id="category-filters" class="flex flex-wrap justify-center gap-2 md:gap-4">
                                 </div>
                         <div id="advanced-filters" class="flex flex-wrap justify-center gap-2 md:gap-4">
                             <select id="brand-filter" class="custom-select bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none">
                                  <option value="All">All Brands</option>
                             </select>
                             <select id="goal-filter" class="custom-select bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none">
                                <option value="All">All Goals</option>
                             </select>
                             <select id="sort-by-select" class="custom-select bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none">
                                 <option value="default">Default Sorting</option>
                                 <option value="price-asc">Price: Low to High</option>
                                 <option value="price-desc">Price: High to Low</option>
                                 <option value="rating-desc">Top Rated</option>
                             </select>
                         </div>
                     </div>
                    <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                        </div>
                    <div id="pagination-controls" class="flex justify-center items-center gap-2 mt-12"></div>
                </div>
            </section>

            <section id="about" class="py-20 bg-slate-800/50">
                <div class="container mx-auto px-6">
                    <div class="max-w-3xl mx-auto text-center animate-on-scroll fade-in-up">
                        <h2 class="text-3xl md:text-5xl font-bold text-white mb-4">About Ajay's Nutrition</h2>
                         <div class="w-24 h-1 bg-gradient-to-r from-cyan-500 to-teal-400 mx-auto mt-6 rounded mb-8"></div>
                        <p class="text-slate-300 mb-4 leading-relaxed text-lg">Welcome to Ajay's Nutrition! My name is Ajay Thakur, and my passion for fitness led me to open this store. I was tired of seeing overpriced, fake supplements flood the market. My mission is simple: to provide 100% genuine, lab-tested supplements at a fair price.</p>
                    </div>
                </div>
            </section>

             <section id="contact" class="py-20 bg-slate-900">
                  <div class="container mx-auto px-6">
                       <div class="text-center mb-16 animate-on-scroll fade-in-up"><h2 class="text-3xl md:text-5xl font-bold text-white">Get In Touch</h2><p class="text-slate-400 mt-4 max-w-2xl mx-auto">Visit us or drop us a line. We're here to help you on your fitness journey!</p><div class="w-24 h-1 bg-gradient-to-r from-cyan-500 to-teal-400 mx-auto mt-6 rounded"></div></div>
                       <div class="flex flex-col lg:flex-row gap-8">
                            <div class="lg:w-1/2 bg-slate-800/40 backdrop-blur-sm border border-slate-700 p-8 rounded-lg animate-on-scroll fade-in-up">
                                <h3 class="text-2xl font-bold text-white mb-6">Contact Information</h3>
                                <div class="space-y-6">
                                     <div class="flex items-start space-x-4"><i data-lucide="map-pin" class="text-cyan-400 mt-1 flex-shrink-0"></i><div><h4 class="font-semibold text-white">Our Location</h4><p class="text-slate-400">VIP Rd, Kaurin Bhatha, Basantpur, Rajnandgaon, Chhattisgarh 491441</p></div></div>
                                     <div class="flex items-start space-x-4"><i data-lucide="phone" class="text-cyan-400 mt-1 flex-shrink-0"></i><div><h4 class="font-semibold text-white">Call Us</h4><p class="text-slate-400">+9198274 05400</p></div></div>
                                     <div class="flex items-start space-x-4"><i data-lucide="mail" class="text-cyan-400 mt-1 flex-shrink-0"></i><div><h4 class="font-semibold text-white">Email Us</h4><p class="text-slate-400">contact@ajaysnutrition.com</p></div></div>
                                </div>
                            </div>
                            <div class="lg:w-1/2 h-96 lg:h-auto rounded-lg overflow-hidden border border-slate-700 animate-on-scroll fade-in-up" style="animation-delay: 0.2s;"><iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3725.753331185524!2d81.0163983153926!3d20.96225499547849!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3a2e4726e8284699%3A0x6336e3992b8f8861!2sAjay's%20Nutrition!5e0!3m2!1sen!2sin!4v1699446861214!5m2!1sen!2sin" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
                       </div>
                  </div>
             </section>

            <section id="authenticity" class="py-20 bg-slate-800/50">
                <div class="container mx-auto px-6">
                    <div class="max-w-3xl mx-auto animate-on-scroll fade-in-up">
                        <h2 class="text-3xl md:text-5xl font-bold text-white mb-4 text-center">Verify Your Product</h2>
                        <div class="w-24 h-1 bg-gradient-to-r from-cyan-500 to-teal-400 mx-auto mt-6 rounded mb-8"></div>
                        <div class="text-slate-300 space-y-4 leading-relaxed bg-slate-700/60 backdrop-blur-sm border border-slate-600 p-8 rounded-lg">
                            <p>At Ajay's Nutrition, we guarantee 100% authenticity. Every product you buy from us is sourced directly from the brands or their official importers. We encourage you to verify your purchase to ensure your peace of mind.</p>
                            <h4 class="text-xl font-semibold text-white pt-4">How to Verify:</h4>
                            <ul class="list-disc list-inside space-y-2">
                                <li><strong>Check the Seal:</strong> Every genuine product comes with a factory-sealed cap and an inner seal. Do not accept the product if the seal is broken.</li>
                                <li><strong>Scratch & Verify Code:</strong> Most major brands include a unique scratch code on the product packaging. You can visit the brand's official website and enter this code to verify authenticity instantly.</li>
                                <li><strong>Importer's Sticker:</strong> Look for the official importer's sticker on the product. This sticker contains crucial information, including the import date and FSSAI license number.</li>
                                <li><strong>Contact Us:</strong> If you have any doubts about your product, please do not hesitate to contact our customer support with your order details and product images. We are here to help you.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <section id="return-policy" class="py-20 bg-slate-900">
                <div class="container mx-auto px-6">
                    <div class="max-w-3xl mx-auto animate-on-scroll fade-in-up">
                        <h2 class="text-3xl md:text-5xl font-bold text-white mb-4 text-center">Return Policy</h2>
                         <div class="w-24 h-1 bg-gradient-to-r from-cyan-500 to-teal-400 mx-auto mt-6 rounded mb-8"></div>
                        <div class="text-slate-300 space-y-4 leading-relaxed">
                            <p>We have a 7-day return policy, which means you have 7 days after receiving your item to request a return.</p>
                            <p>To be eligible for a return, your item must be in the same condition that you received it, unopened, with the seal intact, and in its original packaging. You’ll also need the receipt or proof of purchase.</p>
                            <p>To start a return, you can contact us at contact@ajaysnutrition.com. If your return is accepted, we’ll send you instructions on how and where to send your package. Items sent back to us without first requesting a return will not be accepted.</p>
                            <h4 class="text-xl font-semibold text-white pt-4">Damages and issues</h4>
                            <p>Please inspect your order upon reception and contact us immediately if the item is defective, damaged or if you receive the wrong item, so that we can evaluate the issue and make it right.</p>
                             <h4 class="text-xl font-semibold text-white pt-4">Refunds</h4>
                            <p>We will notify you once we’ve received and inspected your return, and let you know if the refund was approved or not. If approved, you’ll be automatically refunded on your original payment method. Please remember it can take some time for your bank or credit card company to process and post the refund too.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="faq" class="py-20 bg-slate-800/50">
                <div class="container mx-auto px-6">
                    <div class="max-w-3xl mx-auto">
                        <h2 class="text-3xl md:text-5xl font-bold text-white mb-4 text-center animate-on-scroll fade-in-up">Frequently Asked Questions</h2>
                        <div class="w-24 h-1 bg-gradient-to-r from-cyan-500 to-teal-400 mx-auto mt-6 rounded mb-8 animate-on-scroll fade-in-up" style="animation-delay: 0.1s;"></div>
                        <div id="faq-accordion" class="space-y-4">
                            <div class="bg-slate-700/60 backdrop-blur-sm border border-slate-600 rounded-lg animate-on-scroll fade-in-up" style="animation-delay: 0.2s;">
                                <button class="faq-question w-full flex justify-between items-center text-left p-6">
                                    <span class="text-lg font-semibold text-white">I have a doubt about authenticity. How can I be sure?</span>
                                    <i data-lucide="plus" class="faq-icon text-cyan-400 transition-transform duration-300"></i>
                                </button>
                                <div class="faq-answer px-6 pb-6 text-slate-300">
                                    <p>We guarantee 100% authenticity. All our products are sourced directly from the official importers and brands. You can verify the product using the scratch code on the brand's official website and by checking for the official importer's sticker. For more details, please see our <a href="#authenticity" class="text-cyan-400 underline">Authenticity</a> section.</p>
                                </div>
                            </div>
                            <div class="bg-slate-700/60 backdrop-blur-sm border border-slate-600 rounded-lg animate-on-scroll fade-in-up" style="animation-delay: 0.3s;">
                                <button class="faq-question w-full flex justify-between items-center text-left p-6">
                                    <span class="text-lg font-semibold text-white">What is the status of my order?</span>
                                    <i data-lucide="plus" class="faq-icon text-cyan-400 transition-transform duration-300"></i>
                                </button>
                                <div class="faq-answer px-6 pb-6 text-slate-300">
                                    <p>You can use the "My Orders" link in the header or footer to look up your order status. Simply enter the email address you used during checkout to see your complete order history.</p>
                                </div>
                            </div>
                             <div class="bg-slate-700/60 backdrop-blur-sm border border-slate-600 rounded-lg animate-on-scroll fade-in-up" style="animation-delay: 0.4s;">
                                <button class="faq-question w-full flex justify-between items-center text-left p-6">
                                    <span class="text-lg font-semibold text-white">What payment methods do you accept?</span>
                                    <i data-lucide="plus" class="faq-icon text-cyan-400 transition-transform duration-300"></i>
                                </button>
                                <div class="faq-answer px-6 pb-6 text-slate-300">
                                    <p>We accept all major payment methods, including Credit Cards, Debit Cards, UPI (Google Pay, PhonePe, etc.), and Net Banking through our secure Razorpay payment gateway. We also offer Cash on Delivery (COD) for eligible orders.</p>
                                </div>
                            </div>
                             <div class="bg-slate-700/60 backdrop-blur-sm border border-slate-600 rounded-lg animate-on-scroll fade-in-up" style="animation-delay: 0.5s;">
                                <button class="faq-question w-full flex justify-between items-center text-left p-6">
                                    <span class="text-lg font-semibold text-white">What is your return process?</span>
                                    <i data-lucide="plus" class="faq-icon text-cyan-400 transition-transform duration-300"></i>
                                </button>
                                <div class="faq-answer px-6 pb-6 text-slate-300">
                                    <p>We have a 7-day return policy for unopened items with the seal intact. To start a return, please contact us at contact@ajaysnutrition.com with your order details. You can read the full policy in our <a href="#return-policy" class="text-cyan-400 underline">Return Policy</a> section.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-black/30 border-t border-slate-800">
            <div class="container mx-auto px-6 py-8">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                      <div class="lg:col-span-1 animate-on-scroll fade-in-up" style="animation-delay: 0s;">
                           <a href="#home" class="text-xl font-bold gradient-text">Ajay's Nutrition</a>
                           <p class="text-slate-400 mt-4">© 2024 Ajay's Nutrition. All Rights Reserved.</p>
                           <div class="flex items-center space-x-4 mt-4">
                               <a href="https://www.instagram.com/ajaysnutrition?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==" target="_blank" class="text-slate-400 hover:text-cyan-400 transition duration-300"><i data-lucide="instagram"></i></a>
                               <a href="https://www.facebook.com/share/1XHcCQH1ye/" target="_blank" class="text-slate-400 hover:text-cyan-400 transition duration-300"><i data-lucide="facebook"></i></a>
                          </div>
                      </div>
                      <div class="animate-on-scroll fade-in-up" style="animation-delay: 0.1s;">
                           <h3 class="text-white font-semibold tracking-wider">Quick Links</h3>
                           <div class="mt-4 flex flex-col space-y-2">
                                <a href="#about" class="text-slate-400 hover:text-cyan-400">About Us</a>
                                <a href="#contact" class="text-slate-400 hover:text-cyan-400">Contact Us</a>
                                <a href="#faq" class="text-slate-400 hover:text-cyan-400">FAQ</a>
                                <a href="#" id="admin-login-link" class="text-slate-400 hover:text-cyan-400">Admin Login</a>
                           </div>
                      </div>
                       <div class="animate-on-scroll fade-in-up" style="animation-delay: 0.2s;">
                           <h3 class="text-white font-semibold tracking-wider">Policies</h3>
                           <div class="mt-4 flex flex-col space-y-2">
                                <a href="#authenticity" class="text-slate-400 hover:text-cyan-400">Authenticity</a>
                                <a href="#return-policy" class="text-slate-400 hover:text-cyan-400">Return Policy</a>
                                <a href="#" class="text-slate-400 hover:text-cyan-400">Terms of Service</a>
                                <a href="#" class="text-slate-400 hover:text-cyan-400">Privacy Policy</a>
                           </div>
                           <div class="mt-6">
                               <h3 class="text-white font-semibold tracking-wider">We Accept</h3>
                               <div class="flex items-center flex-wrap gap-4 mt-4">
                                   <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" alt="Visa" class="h-6 bg-white px-2 py-1 rounded-md object-contain">
                                   <img src="https://upload.wikimedia.org/wikipedia/commons/a/a4/Mastercard_2019_logo.svg" alt="Mastercard" class="h-8 object-contain">
                                   <img src="https://upload.wikimedia.org/wikipedia/commons/c/cb/Rupay-Logo.png" alt="Rupay" class="h-10 bg-white px-2 py-1 rounded-md object-contain">
                                   <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg" alt="UPI" class="h-8 object-contain">
                                   <img src="https://upload.wikimedia.org/wikipedia/commons/4/42/Paytm_logo.svg" alt="Paytm" class="h-5 object-contain">
                                   <span class="text-slate-300 font-semibold text-sm">Net Banking</span>
                               </div>
                           </div>
                      </div>
                      <div class="w-full animate-on-scroll fade-in-up" style="animation-delay: 0.3s;">
                           <h3 class="text-white font-semibold tracking-wider">Subscribe</h3>
                           <p class="text-slate-400 mt-4">Get the latest on sales, new releases and more.</p>
                           <form id="newsletter-form" class="flex mt-4">
                               <input type="email" id="newsletter-email" placeholder="Enter your email" class="w-full bg-slate-700 border-slate-600 rounded-l-lg px-3 py-2 text-white focus:outline-none" required>
                               <button type="submit" class="bg-gradient-to-r from-cyan-500 to-teal-400 hover:from-cyan-600 hover:to-teal-500 text-gray-900 font-bold py-2 px-4 rounded-r-lg">
                                   <i data-lucide="arrow-right"></i>
                               </button>
                           </form>
                      </div>
                 </div>
            </div>
        </footer>
    </div>

    <div id="product-detail-view" class="hidden min-h-screen bg-slate-900 text-white">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <button id="back-to-products-grid" class="flex items-center gap-2 text-cyan-400 font-semibold mb-8"><i data-lucide="arrow-left"></i> Back to Products</button>
            <div id="product-detail-content" class="grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12">
                 </div>
            <div id="product-info-accordion" class="mt-16">
                </div>
             <div id="reviews-section" class="mt-16">
                 </div>
            <div id="related-products-section" class="mt-16">
                </div>
        </div>
    </div>

    <div id="customer-view" class="hidden min-h-screen bg-slate-900 text-white p-4 sm:p-6 lg:p-8">
        <div class="container mx-auto">
            <div id="customer-lookup-screen">
                <div class="max-w-md mx-auto mt-20">
                    <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-8 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-bold text-center text-cyan-400 mb-6">Track Your Orders</h2>
                        <form id="customer-lookup-form">
                            <div class="mb-4">
                                <label for="customerLookupEmail" class="block text-slate-300 mb-2">Enter your email to find your orders</label>
                                <input type="email" id="customerLookupEmail" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none" required>
                            </div>
                            <p id="customer-lookup-error" class="text-red-500 text-sm mb-4 hidden">No orders found for this email.</p>
                            <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Find Orders</button>
                        </form>
                        <button id="back-to-shop-3" class="w-full mt-4 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Back to Shop</button>
                    </div>
                </div>
            </div>
            <div id="customer-orders-screen" class="hidden">
                 <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-8">
                    <h1 class="text-3xl font-bold text-cyan-400">Your Orders</h1>
                    <div>
                        <button id="lookup-another-email-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 mr-2">Check Another Email</button>
                        <button id="back-to-shop-4" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Back to Shop</button>
                    </div>
                </div>
                 <div id="customer-order-list" class="space-y-4 max-h-[70vh] overflow-y-auto no-scrollbar">
                     </div>
            </div>
        </div>
    </div>
    
    <div id="admin-view" class="hidden min-h-screen bg-slate-900 text-white p-4 sm:p-6 lg:p-8">
        <div id="login-screen" class="max-w-md mx-auto mt-20">
            <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-8 rounded-lg shadow-xl"><h2 class="text-2xl font-bold text-center text-cyan-400 mb-6">Admin Login</h2><form id="login-form"><div class="mb-4"><label for="password" class="block text-slate-300 mb-2">Password</label><input type="password" id="password" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none" required></div><p id="login-error" class="text-red-500 text-sm mb-4 hidden">Incorrect password.</p><button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Login</button></form><button id="back-to-shop-1" class="w-full mt-4 bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Back to Shop</button></div>
        </div>
        <div id="admin-dashboard" class="hidden">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <h1 class="text-3xl font-bold text-cyan-400">Admin Panel</h1>
                <div>
                    <button id="back-to-shop-2" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 mr-2">Back to Shop</button>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</button>
                </div>
            </div>
            <div class="mb-8 border-b border-slate-700">
                <nav class="flex flex-wrap space-x-4" aria-label="Tabs">
                    <button id="tab-dashboard" class="tab-btn text-cyan-400 border-b-2 border-cyan-400 px-3 py-2 font-medium">Dashboard</button>
                    <button id="tab-products" class="tab-btn text-slate-400 hover:text-white px-3 py-2 font-medium">Products</button>
                    <button id="tab-orders" class="tab-btn text-slate-400 hover:text-white px-3 py-2 font-medium">All Orders</button>
                    <button id="tab-daily-orders" class="tab-btn text-slate-400 hover:text-white px-3 py-2 font-medium">Daily Orders</button>
                    <button id="tab-coupons" class="tab-btn text-slate-400 hover:text-white px-3 py-2 font-medium">Coupons</button>
                    <button id="tab-subscribers" class="tab-btn text-slate-400 hover:text-white px-3 py-2 font-medium">Subscribers</button>
                    <button id="tab-settings" class="tab-btn text-slate-400 hover:text-white px-3 py-2 font-medium">Settings</button>
                </nav>
            </div>
            
            <div id="content-dashboard">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-6 rounded-lg"><h3 class="text-slate-400 text-sm font-medium">Total Revenue</h3><p id="stats-total-revenue" class="text-3xl font-bold text-cyan-400 mt-2">₹0</p></div>
                    <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-6 rounded-lg"><h3 class="text-slate-400 text-sm font-medium">Orders (Last 30 Days)</h3><p id="stats-orders-30d" class="text-3xl font-bold text-white mt-2">0</p></div>
                    <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-6 rounded-lg"><h3 class="text-slate-400 text-sm font-medium">Total Products</h3><p id="stats-total-products" class="text-3xl font-bold text-white mt-2">0</p></div>
                </div>
                 <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-4">Top 5 Selling Products</h3>
                    <div id="stats-top-products" class="space-y-3">
                        <p class="text-slate-400">Calculating...</p>
                    </div>
                </div>
            </div>

            <div id="content-products" class="hidden">
                 <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-6 rounded-lg shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
                        <h2 class="text-xl font-semibold">Manage Products</h2>
                        <button id="add-new-product-btn" class="w-full sm:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add New Product</button>
                    </div>
                    <div id="admin-product-list" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar"><p class="text-slate-400">Loading products...</p></div>
                </div>
            </div>

            <div id="content-orders" class="hidden">
                 <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">All Orders</h2>
                    <div id="admin-order-list" class="space-y-4 max-h-[70vh] overflow-y-auto no-scrollbar"><p class="text-slate-400">Loading orders...</p></div>
                </div>
            </div>

            <div id="content-daily-orders" class="hidden">
                <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-6 rounded-lg shadow-lg">
                   <h2 class="text-xl font-semibold mb-4">Orders for Today (<span id="today-date"></span>)</h2>
                   <div id="admin-daily-order-list" class="space-y-4 max-h-[70vh] overflow-y-auto no-scrollbar"><p class="text-slate-400">Loading today's orders...</p></div>
                </div>
             </div>
            
            <div id="content-coupons" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Add New Coupon</h2>
                        <form id="add-coupon-form" class="space-y-4">
                            <div><label for="couponCode" class="block text-sm font-medium text-slate-300">Coupon Code</label><input type="text" id="couponCode" placeholder="E.g., SAVE10" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2 uppercase" required></div>
                            <div><label for="discountType" class="block text-sm font-medium text-slate-300">Discount Type</label><select id="discountType" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2"><option value="percent">Percentage</option><option value="fixed">Fixed Amount</option></select></div>
                            <div><label for="discountValue" class="block text-sm font-medium text-slate-300">Value</label><input type="number" id="discountValue" placeholder="E.g., 10 or 100" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required></div>
                            <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add Coupon</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold mb-4">Manage Coupons</h2>
                        <div id="admin-coupon-list" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar"><p class="text-slate-400">Loading coupons...</p></div>
                    </div>
                </div>
            </div>

            <div id="content-subscribers" class="hidden">
                 <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">Newsletter Subscribers</h2>
                    <div id="admin-subscriber-list" class="space-y-2 max-h-[70vh] overflow-y-auto no-scrollbar"><p class="text-slate-400">Loading subscribers...</p></div>
                </div>
            </div>
            
            <div id="content-settings" class="hidden">
                <div class="max-w-xl mx-auto bg-slate-800/60 backdrop-blur-xl border border-slate-700 p-8 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-6">Site Settings</h2>
                    <form id="settings-form" class="space-y-6">
                        <div>
                            <h3 class="text-lg font-medium text-white mb-2">Promotional Banner</h3>
                             <div class="flex items-center mb-4">
                                 <input type="checkbox" id="bannerEnabled" class="h-4 w-4 rounded text-cyan-500 bg-slate-700 border-slate-600">
                                 <label for="bannerEnabled" class="ml-3 block text-sm font-medium text-slate-300">Enable Promotional Banner</label>
                            </div>
                            <div>
                                <label for="bannerMessage" class="block text-sm font-medium text-slate-300">Banner Message</label>
                                <input type="text" id="bannerMessage" placeholder="e.g., FREE SHIPPING ON ORDERS OVER ₹2000" class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm text-white px-3 py-2">
                            </div>
                        </div>
                        <div class="pt-4">
                             <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Save Settings</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div id="admin-product-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>
    <div id="admin-variant-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4"></div>

    <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"></div>
    <div id="cart-sidebar" class="fixed top-0 right-0 h-full w-full max-w-md bg-slate-800/80 backdrop-blur-sm border-l border-slate-700 text-white shadow-lg z-50 transform translate-x-full"><div class="flex flex-col h-full"><div class="flex justify-between items-center p-6 border-b border-slate-700"><h2 class="text-2xl font-bold text-cyan-400">Your Cart</h2><button id="close-cart-button" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button></div><div id="cart-items" class="flex-grow p-6 overflow-y-auto no-scrollbar"></div>
    <div class="p-6 border-t border-slate-700 bg-slate-800/80">
        <div id="coupon-area">
            <div class="flex gap-2 mb-4">
                <input type="text" id="coupon-input" placeholder="Enter Coupon Code" class="flex-grow bg-slate-700 border-slate-600 rounded-md shadow-sm text-white px-3 py-2 uppercase">
                <button id="apply-coupon-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg">Apply</button>
            </div>
            <p id="coupon-message" class="text-sm mb-4 h-5"></p>
        </div>
        <div class="space-y-2 mb-4">
            <div class="flex justify-between items-center"><span class="text-slate-300">Subtotal</span><span id="cart-subtotal" class="font-semibold text-white">₹0</span></div>
            <div id="discount-row" class="hidden flex justify-between items-center text-green-400"><span >Discount</span><span id="cart-discount">-₹0</span></div>
        </div>
        <div class="flex justify-between items-center font-bold text-lg mb-4 border-t border-slate-700 pt-4"><span>Total</span><span id="cart-total" class="text-xl text-cyan-400">₹0</span></div>
        <button id="checkout-button" class="w-full bg-gradient-to-r from-cyan-500 to-teal-400 hover:from-cyan-600 hover:to-teal-500 text-gray-900 font-bold py-3 rounded-lg transition duration-300 disabled:bg-slate-600 disabled:cursor-not-allowed">Proceed to Checkout</button>
    </div>
    </div></div>

    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 rounded-lg shadow-xl w-full max-w-2xl p-8 relative no-scrollbar overflow-y-auto max-h-screen">
            <button id="close-checkout-button" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            <h2 class="text-2xl font-bold text-cyan-400 mb-6">Checkout</h2>
            <div id="checkout-content"></div>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h3 id="confirm-title" class="text-lg font-bold text-white mb-4">Are you sure?</h3>
            <p id="confirm-text" class="text-slate-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button id="confirm-ok" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Delete</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[100]"></div>

    <div id="loading-overlay" class="fixed inset-0 z-[99] hidden items-center justify-center">
        <div class="spinner h-12 w-12 rounded-full border-4 border-solid border-slate-600"></div>
    </div>

    <button id="scroll-to-top" class="fixed bottom-5 right-5 bg-cyan-500/80 hover:bg-cyan-500 text-white p-3 rounded-full shadow-lg transition-all duration-300 transform translate-y-20 opacity-0 z-50">
        <i data-lucide="arrow-up"></i>
    </button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, query, orderBy, where, getDocs, getDoc, setDoc, writeBatch, runTransaction, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- IMPORTANT: SECURITY & CONFIGURATION NOTES ---
        // 1. Firebase Config: In a real production app, these keys should be stored in environment variables, not directly in the code.
        // 2. Admin Password: The current admin login is NOT secure. It uses a hardcoded password visible in the public code.
        //    For a real application, implement a proper authentication system (e.g., Firebase Authentication with email/password) and use
        //    Firestore Security Rules with Custom Claims to grant admin privileges. This is for demonstration purposes only.
        
        const firebaseConfig = {
         apiKey: "AIzaSyD6WMcQB-hwRtORwFYkQD1tbQxihLi8_NI",
         authDomain: "ajay-s-nutrition.firebaseapp.com",
         projectId: "ajay-s-nutrition",
         storageBucket: "ajay-s-nutrition.firebasestorage.app",
         messagingSenderId: "859946452081",
         appId: "1:859946452081:web:65aa593f47e85862d207d0",
         measurementId: "G-KL537177V8"
        };
        
        // --- INITIALIZATION ---
        let app, auth, db, storage;
        
        // --- DOM ELEMENTS ---
        const DOMElements = {
            productGrid: document.getElementById('product-grid'),
            adminProductList: document.getElementById('admin-product-list'),
            adminOrderList: document.getElementById('admin-order-list'),
            adminDailyOrderList: document.getElementById('admin-daily-order-list'),
            adminCouponList: document.getElementById('admin-coupon-list'),
            adminSubscriberList: document.getElementById('admin-subscriber-list'),
            cartItemsContainer: document.getElementById('cart-items'),
            cartCount: document.getElementById('cart-count'),
            cartSubtotal: document.getElementById('cart-subtotal'),
            cartDiscount: document.getElementById('cart-discount'),
            cartTotal: document.getElementById('cart-total'),
            checkoutButton: document.getElementById('checkout-button'),
            mobileMenu: document.getElementById('mobile-menu'),
            categoryFilters: document.getElementById('category-filters'),
            searchBar: document.getElementById('search-bar'),
            mobileSearchBar: document.getElementById('mobile-search-bar'),
            customerLookupScreen: document.getElementById('customer-lookup-screen'),
            customerOrdersScreen: document.getElementById('customer-orders-screen'),
            customerOrderList: document.getElementById('customer-order-list'),
            productDetailContent: document.getElementById('product-detail-content'),
            reviewsSection: document.getElementById('reviews-section'),
            paginationControls: document.getElementById('pagination-controls'),
            scrollToTopBtn: document.getElementById('scroll-to-top'),
            loadingOverlay: document.getElementById('loading-overlay'),
            todayDateSpan: document.getElementById('today-date')
        };

        // --- APP STATE ---
        let productsCollection, ordersCollection, couponsCollection, settingsCollection, subscribersCollection, usersCollection, wishlistsCollection;
        let cart = [];
        let appliedCoupon = null;
        let allProducts = [];
        let allOrders = [];
        let allUsers = [];
        let currentCategory = 'All';
        let currentSearchTerm = '';
        let currentSort = 'default';
        let currentPage = 1;
        const productsPerPage = 8;
        let currentUser = null;
        let currentProductVariants = [];
        let ordersListener = null; 
        let dailyOrdersListener = null;
        let currentBrand = 'All';
        let currentGoal = 'All';
        let imageFilesToUpload = [];
        let liveLocationData = null; // To store coordinates from geolocation

        // --- UI & VIEW MANAGEMENT ---
        const switchView = (viewName, data = null) => {
            ['shop-view', 'admin-view', 'customer-view', 'product-detail-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
            window.scrollTo(0, 0);
            if (viewName === 'product-detail-view' && data && data.productId) renderProductDetail(data.productId);
            document.getElementById(viewName).classList.remove('hidden');
        };

        const showLoginScreen = () => { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('admin-dashboard').classList.add('hidden'); };
        const showDashboard = () => { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('admin-dashboard').classList.remove('hidden'); };
        const openCart = () => { 
            const sidebar = document.getElementById('cart-sidebar');
            document.getElementById('cart-overlay').classList.remove('hidden'); 
            sidebar.classList.add('open', ...'translate-x-0'.split(' '));
            sidebar.classList.remove('closed', ...'translate-x-full'.split(' '));
        };
        const closeCart = () => { 
            const sidebar = document.getElementById('cart-sidebar');
            document.getElementById('cart-overlay').classList.add('hidden'); 
            sidebar.classList.add('closed', ...'translate-x-full'.split(' '));
            sidebar.classList.remove('open', ...'translate-x-0'.split(' '));
        };
        const closeCheckout = () => { document.getElementById('checkout-modal').classList.add('hidden'); document.getElementById('checkout-modal').classList.remove('flex'); };
        
        const openCheckout = () => {
            const modal = document.getElementById('checkout-modal');
            const content = document.getElementById('checkout-content');

            // Simple check to prevent re-rendering if already open and content is there
            if (content.innerHTML.trim() !== '') {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                return;
            }

            content.innerHTML = `
                <form id="checkout-form" class="space-y-6">
                    <div>
                        <h3 class="text-lg font-medium text-white mb-4">Contact Information</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="customerName" class="block text-sm font-medium text-slate-300">Full Name</label>
                                <input type="text" id="customerName" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required autocomplete="name">
                            </div>
                            <div>
                                <label for="customerPhone" class="block text-sm font-medium text-slate-300">Phone Number</label>
                                <input type="tel" id="customerPhone" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required autocomplete="tel">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="customerEmail" class="block text-sm font-medium text-slate-300">Email Address</label>
                            <input type="email" id="customerEmail" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required autocomplete="email">
                        </div>
                    </div>

                    <div>
                        <fieldset>
                            <legend class="text-lg font-medium text-white mb-2">Delivery Method</legend>
                            <div class="flex gap-4">
                                <label class="flex items-center p-4 border border-slate-600 rounded-lg flex-1 cursor-pointer has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-900/20">
                                    <input type="radio" name="deliveryType" value="delivery" class="h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600" checked>
                                    <span class="ml-3 block text-sm font-medium">Delivery</span>
                                </label>
                                <label class="flex items-center p-4 border border-slate-600 rounded-lg flex-1 cursor-pointer has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-900/20">
                                    <input type="radio" name="deliveryType" value="pickup" class="h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600">
                                    <span class="ml-3 block text-sm font-medium">In-Store Pickup</span>
                                </label>
                            </div>
                        </fieldset>
                    </div>
                    
                    <div id="delivery-address-fields">
                         <h3 class="text-lg font-medium text-white mb-4">Shipping Address</h3>
                         <div class="space-y-4">
                            <div>
                                <label for="customerAddress1" class="block text-sm font-medium text-slate-300">Address Line 1</label>
                                <input type="text" id="customerAddress1" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required autocomplete="address-line1">
                            </div>
                            <div>
                                <label for="customerAddress2" class="block text-sm font-medium text-slate-300">Address Line 2 (Optional)</label>
                                <input type="text" id="customerAddress2" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" autocomplete="address-line2">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div>
                                     <label for="customerCity" class="block text-sm font-medium text-slate-300">City</label>
                                     <input type="text" id="customerCity" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required autocomplete="address-level2">
                                </div>
                                <div>
                                    <label for="customerState" class="block text-sm font-medium text-slate-300">State</label>
                                    <input type="text" id="customerState" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required autocomplete="address-level1">
                                </div>
                                <div>
                                     <label for="customerPincode" class="block text-sm font-medium text-slate-300">Pincode</label>
                                     <input type="text" id="customerPincode" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required autocomplete="postal-code">
                                </div>
                            </div>
                            <div class="mt-4">
                                <button type="button" id="get-location-btn" class="flex items-center justify-center gap-2 w-full bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                                    <i data-lucide="map-pin" class="w-4 h-4"></i> Use Current Location for Accurate Delivery
                                </button>
                                <p id="location-info" class="text-xs text-slate-400 mt-2 text-center h-4"></p>
                            </div>
                         </div>
                    </div>

                    <div class="border-t border-slate-700 pt-6">
                         <h3 class="text-lg font-medium text-white mb-4">Payment Method</h3>
                        <fieldset>
                            <div class="space-y-4">
                                <label class="flex items-center p-4 border border-slate-600 rounded-lg cursor-pointer has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-900/20">
                                    <input type="radio" name="paymentMethod" value="online" class="h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600" checked>
                                    <span class="ml-3 block text-sm font-medium">Pay Online (Card, UPI, Netbanking)</span>
                                </label>
                                <label class="flex items-center p-4 border border-slate-600 rounded-lg cursor-pointer has-[:checked]:border-cyan-500 has-[:checked]:bg-cyan-900/20">
                                    <input type="radio" name="paymentMethod" value="cod" class="h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600">
                                    <span class="ml-3 block text-sm font-medium">Cash on Delivery (COD)</span>
                                </label>
                            </div>
                        </fieldset>
                    </div>

                    <div class="mt-8">
                        <button type="submit" id="pay-button" class="w-full bg-gradient-to-r from-cyan-500 to-teal-400 hover:from-cyan-600 hover:to-teal-500 text-gray-900 font-bold py-3 rounded-lg transition duration-300">Pay Securely</button>
                    </div>
                </form>
            `;

            // Add listener for delivery type toggle
            const deliveryRadios = content.querySelectorAll('input[name="deliveryType"]');
            const addressFields = content.querySelector('#delivery-address-fields');
            const addressInputs = addressFields.querySelectorAll('input');

            const toggleAddressFields = (isPickup) => {
                if (isPickup) {
                    addressFields.classList.add('hidden');
                    addressInputs.forEach(input => input.required = false);
                } else {
                    addressFields.classList.remove('hidden');
                    addressInputs.forEach(input => {
                        // Only set required if it's not the optional address line 2
                        if (input.id !== 'customerAddress2') {
                            input.required = true;
                        }
                    });
                }
            };
            
            deliveryRadios.forEach(radio => {
                radio.addEventListener('change', () => toggleAddressFields(radio.value === 'pickup'));
            });

            // Geolocation Button Listener
            const locationBtn = content.querySelector('#get-location-btn');
            const locationInfo = content.querySelector('#location-info');
            locationBtn.addEventListener('click', async () => {
                if (!navigator.geolocation) {
                    showToast('Geolocation is not supported by your browser.', true);
                    return;
                }
                
                if (!window.isSecureContext) {
                    showToast('Location features require a secure (HTTPS) connection.', true);
                    locationInfo.innerHTML = `<span class="text-red-400">❌ Insecure connection.</span>`;
                    return;
                }

                try {
                    // Use the Permissions API for a better user experience
                    const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });

                    if (permissionStatus.state === 'denied') {
                        const errorMessage = "Location access is blocked. Please go to your browser settings to allow location access for this site.";
                        showToast(errorMessage, true);
                        locationInfo.innerHTML = `<span class="text-red-400">❌ ${errorMessage}</span>`;
                        return;
                    }

                    // If 'prompt' or 'granted', proceed with the request.
                    locationBtn.disabled = true;
                    locationInfo.innerHTML = `<span class="text-cyan-400">Fetching location... Please approve the request.</span>`;

                    const options = {
                        enableHighAccuracy: false, // Lower accuracy is more reliable on all devices
                        timeout: 15000, // Increased timeout to 15 seconds
                        maximumAge: 60000 
                    };

                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            liveLocationData = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude
                            };
                            locationInfo.innerHTML = `<span class="text-green-400">✅ Location captured! Fetching address...</span>`;
                            
                            await fetchAddressFromCoords(position.coords.latitude, position.coords.longitude);

                            locationBtn.disabled = false;
                        },
                        (error) => {
                            console.error("Geolocation error:", error);
                            liveLocationData = null;
                            let errorMessage = 'Could not get location.';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = "Location permission was denied. Please enable it in your browser settings.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = "Your location could not be determined. Ensure Wi-Fi is on and location services are enabled for your device and browser.";
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = "The request for your location timed out. Please check your connection and try again.";
                                    break;
                            }
                            showToast(errorMessage, true);
                            locationInfo.innerHTML = `<span class="text-red-400">❌ ${errorMessage}</span>`;
                            locationBtn.disabled = false;
                        },
                        options
                    );
                } catch (e) {
                    console.error("Permissions API error:", e);
                    showToast("Could not check location permissions. Please try again.", true);
                    locationBtn.disabled = false;
                }
            });
            
            // Initial check
            toggleAddressFields(content.querySelector('input[name="deliveryType"]:checked').value === 'pickup');


            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        };

        const showLoading = (show) => { DOMElements.loadingOverlay.style.display = show ? 'flex' : 'none'; };
        
        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-lg transform transition-all duration-300 z-[100] ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-20'); }, 3000);
        };

        const confirmAction = ({ title, text }) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-text').textContent = text;
                modal.classList.remove('hidden'); modal.classList.add('flex');
                const okBtn = document.getElementById('confirm-ok');
                const cancelBtn = document.getElementById('confirm-cancel');
                const onOk = () => { cleanup(); resolve(true); };
                const onCancel = () => { cleanup(); resolve(false); };
                const cleanup = () => {
                    modal.classList.add('hidden'); modal.classList.remove('flex');
                    okBtn.removeEventListener('click', onOk);
                    cancelBtn.removeEventListener('click', onCancel);
                };
                okBtn.addEventListener('click', onOk, { once: true });
                cancelBtn.addEventListener('click', onCancel, { once: true });
            });
        };
        
        // --- CART & COUPON LOGIC ---
        const updateCartTotals = () => {
            const subtotal = cart.reduce((acc, item) => acc + ((item.salePrice || item.price) * item.quantity), 0);
            let discount = 0;
            if (appliedCoupon) {
                if (appliedCoupon.discountType === 'percent') {
                    discount = (subtotal * appliedCoupon.value) / 100;
                } else { // fixed
                    discount = appliedCoupon.value;
                }
                discount = Math.min(subtotal, discount);
            }

            const total = subtotal - discount;

            DOMElements.cartSubtotal.textContent = `₹${subtotal.toLocaleString('en-IN')}`;
            if (discount > 0) {
                DOMElements.cartDiscount.textContent = `-₹${discount.toLocaleString('en-IN')}`;
                document.getElementById('discount-row').classList.remove('hidden');
            } else {
                document.getElementById('discount-row').classList.add('hidden');
            }
            DOMElements.cartTotal.textContent = `₹${total.toLocaleString('en-IN')}`;
            DOMElements.checkoutButton.disabled = cart.length === 0;
        }
        
        const updateCart = () => {
            DOMElements.cartItemsContainer.innerHTML = '';
            let totalItems = 0;
            if (cart.length === 0) { 
                DOMElements.cartItemsContainer.innerHTML = `<p class="text-slate-400 text-center">Your cart is empty.</p>`; 
                appliedCoupon = null;
                document.getElementById('coupon-input').value = '';
                document.getElementById('coupon-message').textContent = '';
            } 
            else {
                cart.forEach(item => {
                    totalItems += item.quantity;
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between gap-4 py-3 border-b border-slate-700';
                    const priceDisplay = item.salePrice 
                        ? `<p class="text-sm text-cyan-400 mt-1">₹${item.salePrice.toLocaleString('en-IN')} <span class="text-slate-500 line-through">₹${item.price.toLocaleString('en-IN')}</span></p>`
                        : `<p class="text-sm text-slate-400 mt-1">₹${item.price.toLocaleString('en-IN')}</p>`;

                    el.innerHTML = `
                        <img src="${item.imageUrl}" alt="${item.name}" class="w-20 h-20 object-cover rounded-md">
                        <div class="flex-grow">
                            <p class="font-semibold text-white">${item.name}</p>
                            <p class="text-xs text-slate-300">${item.flavour} / ${item.size}</p>
                            ${priceDisplay}
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="quantity-change text-cyan-400" data-id="${item.variantId}" data-change="-1">-</button>
                            <span>${item.quantity}</span>
                            <button class="quantity-change text-cyan-400" data-id="${item.variantId}" data-change="1">+</button>
                        </div>
                        <button class="remove-item text-red-400 hover:text-red-500" data-id="${item.variantId}"><i data-lucide="trash-2" class="w-5 h-5"></i></button>`;
                    DOMElements.cartItemsContainer.appendChild(el);
                });
            }
            
            DOMElements.cartCount.textContent = totalItems;
            updateCartTotals();
            lucide.createIcons();
        };

        const addToCart = (variant) => { 
            if (variant.quantity <= 0) { showToast('This item is out of stock.', true); return; }
            const existingItem = cart.find(item => item.variantId === variant.id); 
            if (existingItem) { 
                if (existingItem.quantity < variant.quantity) {
                    existingItem.quantity++; showToast('Item quantity updated!'); 
                } else { showToast('No more stock available for this item.', true); return; }
            } else { 
                cart.push({ 
                    variantId: variant.id, 
                    productId: variant.productId,
                    name: variant.productName,
                    imageUrl: variant.productImageUrl,
                    size: variant.size,
                    flavour: variant.flavour,
                    price: variant.price,
                    salePrice: variant.salePrice || null,
                    quantity: 1 
                }); 
                showToast('Item added to cart!'); 
            }
            updateCart(); 
        };
        const changeQuantity = (variantId, change) => { const item = cart.find(i => i.variantId === variantId); if (item) { item.quantity += change; if (item.quantity <= 0) { cart = cart.filter(i => i.variantId !== variantId); } updateCart(); } };
        const removeFromCart = (variantId) => { cart = cart.filter(i => i.variantId !== variantId); updateCart(); };
        
        const applyCoupon = async () => {
            const code = document.getElementById('coupon-input').value.toUpperCase().trim();
            const messageEl = document.getElementById('coupon-message');
            if(!code) return;

            try {
                const couponRef = doc(db, 'coupons', code);
                const couponSnap = await getDoc(couponRef);

                if (couponSnap.exists()) {
                    appliedCoupon = { id: couponSnap.id, ...couponSnap.data() };
                    messageEl.textContent = `Coupon "${code}" applied!`;
                    messageEl.className = 'text-sm mb-4 h-5 text-green-400';
                    updateCartTotals();
                } else {
                    appliedCoupon = null;
                    messageEl.textContent = 'Invalid coupon code.';
                    messageEl.className = 'text-sm mb-4 h-5 text-red-400';
                    updateCartTotals();
                }
            } catch (error) { console.error("Error applying coupon:", error); messageEl.textContent = 'Could not apply coupon.'; messageEl.className = 'text-sm mb-4 h-5 text-red-400'; }
        };

        const categoryColors = {
            'Protein':     { bg: 'bg-gradient-to-br from-blue-900/50 to-slate-900',   text: 'text-blue-200',   subtext: 'text-blue-300' },
            'Mass Gainer': { bg: 'bg-gradient-to-br from-green-900/50 to-slate-900',  text: 'text-green-200',  subtext: 'text-green-300' },
            'Creatine':    { bg: 'bg-gradient-to-br from-slate-700/50 to-slate-900',  text: 'text-slate-100',  subtext: 'text-slate-300' },
            'Pre-Workout': { bg: 'bg-gradient-to-br from-red-900/50 to-slate-900',    text: 'text-red-200',    subtext: 'text-red-300' },
            'Vitamins':    { bg: 'bg-gradient-to-br from-teal-800/50 to-slate-900', text: 'text-teal-200', subtext: 'text-teal-300' },
            'Other':       { bg: 'bg-gradient-to-br from-purple-900/50 to-slate-900', text: 'text-purple-200', subtext: 'text-purple-300' },
            'default':     { bg: 'bg-slate-800/40', text: 'text-white', subtext: 'text-slate-400', priceGradient: true }
        };

        // --- PRODUCT, REVIEW, WISHLIST RENDERING ---
        const renderProductGrid = (products, gridElement) => {
            gridElement.innerHTML = '';
             if (products.length === 0) { 
                gridElement.innerHTML = `<p class="text-slate-400 col-span-full text-center">No products match your search.</p>`;
                return;
             }

            products.forEach((product, index) => {
                const card = document.createElement('div');
                const colors = categoryColors[product.category] || categoryColors.default;
                card.className = `product-card-hover rounded-lg overflow-hidden flex flex-col border border-slate-700/50 ${colors.bg} animate-on-scroll fade-in-up`;
                card.style.transitionDelay = `${index * 50}ms`;
                
                const priceString = product.minPrice ? `From ₹${product.minPrice.toLocaleString('en-IN')}` : 'View Options';
                const saleBadge = product.hasSale ? '<span class="absolute top-3 left-3 bg-gradient-to-r from-red-500 to-orange-500 text-white text-xs font-semibold px-2 py-1 rounded-full z-10">SALE</span>' : '';
                const priceHtml = colors.priceGradient 
                    ? `<span class="text-2xl font-extrabold gradient-text">${priceString}</span>`
                    : `<span class="text-2xl font-extrabold text-white">${priceString}</span>`;

                card.innerHTML = `
                    <div class="relative">
                        <img data-id="${product.id}" src="${product.imageUrl}" alt="${product.name}" class="w-full h-64 object-contain cursor-pointer p-4 bg-slate-900/30" onerror="this.onerror=null;this.src='https://placehold.co/400x400/1e293b/FFFFFF?text=Image+Error';">
                         ${saleBadge}
                    </div>
                    <div data-id="${product.id}" class="p-6 pt-2 flex flex-col flex-grow cursor-pointer">
                        <div>
                            <p class="${colors.subtext} text-sm mb-1 font-medium">${product.brand || ''}</p>
                            <h3 class="text-lg font-semibold text-white mb-2 h-14">${product.name}</h3>
                            <p class="${colors.subtext} text-sm">${product.category}</p>
                        </div>
                        <div class="mt-auto pt-4">
                            ${priceHtml}
                        </div>
                    </div>`;
                card.addEventListener('click', () => switchView('product-detail-view', { productId: product.id }));
                gridElement.appendChild(card);
            });
             lucide.createIcons();
        };

        const renderProductDetail = async (productId) => {
            DOMElements.productDetailContent.innerHTML = `<div class="col-span-full text-center text-slate-400">Loading product...</div>`;
            const product = allProducts.find(p => p.id === productId);
            if(!product) { DOMElements.productDetailContent.innerHTML = `<div class="col-span-full text-center text-red-400">Product not found.</div>`; return; }

            const variantsRef = collection(db, `products/${productId}/variants`);
            const variantSnapshot = await getDocs(variantsRef);
            currentProductVariants = variantSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), productId, productName: product.name, productImageUrl: product.imageUrl }));
            
            renderProductInfoAccordion(product);
            renderReviews(productId);
            renderRelatedProducts(product);

            if (currentProductVariants.length === 0) { DOMElements.productDetailContent.innerHTML = `<div class="col-span-full text-center text-slate-400">No options available for this product yet.</div>`; return; }

            const sizes = [...new Set(currentProductVariants.map(v => v.size))];
            
            const imageUrls = (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls : [product.imageUrl];
            const thumbnailsHtml = imageUrls.map((url, index) => `
                <img src="${url}" alt="Thumbnail ${index + 1}" data-full-src="${url}" class="w-full h-24 object-cover rounded-md cursor-pointer border-2 hover:border-cyan-400 transition-all ${index === 0 ? 'border-cyan-500' : 'border-slate-700'}">
            `).join('');

            DOMElements.productDetailContent.innerHTML = `
                <div class="space-y-3">
                    <div class="bg-slate-800/50 rounded-lg p-2 border border-slate-700">
                       <img id="main-product-image" src="${imageUrls[0]}" alt="${product.name}" class="w-full rounded-lg shadow-lg aspect-square object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x600/1e293b/FFFFFF?text=Image+Not+Found';">
                    </div>
                    <div id="product-thumbnails" class="grid grid-cols-5 gap-3">
                        ${thumbnailsHtml}
                    </div>
                </div>
                <div>
                    <h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">${product.name}</h1>
                    <p class="text-slate-400 mb-4">${product.category}</p>
                    <p class="text-slate-300 leading-relaxed mb-6">${product.description}</p>
                    <div class="mb-6"><h3 class="text-lg font-semibold text-slate-300 mb-3">Pack Size</h3><div id="size-selector" class="flex flex-wrap gap-3"></div></div>
                    <div class="mb-6"><h3 class="text-lg font-semibold text-slate-300 mb-3">Flavour</h3><select id="flavour-selector" class="custom-select w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:outline-none"></select></div>
                    <div class="flex items-center justify-between my-8"><div id="product-price-container" class="flex items-baseline"></div><div id="stock-indicator"></div></div>
                    <button id="detail-add-to-cart-btn" class="interactive-glow w-full bg-gradient-to-r from-cyan-500 to-teal-400 hover:from-cyan-600 hover:to-teal-500 text-gray-900 font-bold py-4 px-4 rounded-lg transition duration-300 disabled:bg-slate-600 disabled:cursor-not-allowed">Add to Cart</button>
                </div>
            `;
            updateVariantSelectors(sizes[0]);
        };

        const updateVariantSelectors = (selectedSize) => {
            const sizeSelector = document.getElementById('size-selector');
            const flavourSelector = document.getElementById('flavour-selector');
            const sizes = [...new Set(currentProductVariants.map(v => v.size))];
            
            sizeSelector.innerHTML = sizes.map(s => `<button class="size-btn text-slate-300 bg-slate-800/50 hover:bg-slate-700 font-semibold py-2 px-4 rounded-lg transition duration-300 border border-slate-600 ${s === selectedSize ? 'active' : ''}" data-size="${s}">${s}</button>`).join('');

            const variantsForSize = currentProductVariants.filter(v => v.size === selectedSize);
            const flavours = variantsForSize.map(v => v.flavour);
            flavourSelector.innerHTML = flavours.map(f => `<option value="${f}">${f}</option>`).join('');
            
            updatePriceAndStock(selectedSize, flavours[0]);
        }
        
        const updatePriceAndStock = (selectedSize, selectedFlavour) => {
             const selectedVariant = currentProductVariants.find(v => v.size === selectedSize && v.flavour === selectedFlavour);
            if (!selectedVariant) return;

            const priceContainer = document.getElementById('product-price-container');
            const stockIndicator = document.getElementById('stock-indicator');
            const addToCartBtn = document.getElementById('detail-add-to-cart-btn');

            priceContainer.innerHTML = selectedVariant.salePrice
                ? `<span class="text-4xl font-bold text-cyan-400">₹${selectedVariant.salePrice.toLocaleString('en-IN')}</span> <span class="text-2xl text-slate-500 line-through ml-2">₹${selectedVariant.price.toLocaleString('en-IN')}</span>`
                : `<span class="text-4xl font-bold text-cyan-400">₹${selectedVariant.price.toLocaleString('en-IN')}</span>`;
            
            if (selectedVariant.quantity > 0) {
                const stockText = selectedVariant.quantity < 5 ? `Low in stock (${selectedVariant.quantity} left)` : 'In Stock';
                const stockColor = selectedVariant.quantity < 5 ? 'text-yellow-400' : 'text-green-400';
                stockIndicator.innerHTML = `<span class="${stockColor} font-semibold">${stockText}</span>`;
                addToCartBtn.disabled = false;
                addToCartBtn.textContent = 'Add to Cart';
            } else {
                stockIndicator.innerHTML = `<span class="text-red-400 font-semibold">Out of Stock</span>`;
                addToCartBtn.disabled = true;
                addToCartBtn.textContent = 'Out of Stock';
            }
            addToCartBtn.onclick = () => addToCart(selectedVariant);
        };

        const renderProductInfoAccordion = (product) => {
            const accordionContainer = document.getElementById('product-info-accordion');
            accordionContainer.innerHTML = ''; // Clear previous content

            let highlightsContent = '';
            const highlights = [
                { label: 'Price Per Serving', value: product.pricePerServing ? `₹${product.pricePerServing}` : null },
                { label: 'Form', value: product.form },
                { label: 'Packaging', value: product.packaging },
            ];
            
            const validHighlights = highlights.filter(h => h.value);
            let benefitsHtml = '';
            if (product.benefits && Array.isArray(product.benefits) && product.benefits.length > 0) {
                benefitsHtml = `<dt class="font-semibold text-white mt-4">Benefits</dt><dd class="text-slate-300 flex flex-wrap gap-2 mt-2">${product.benefits.map(b => `<span class="bg-cyan-900/50 text-cyan-300 text-xs font-medium px-2.5 py-1 rounded-full">${b}</span>`).join('')}</dd>`;
            }

            if (validHighlights.length > 0 || benefitsHtml) {
                highlightsContent = `
                    <dl>
                        ${validHighlights.map(h => `<dt class="font-semibold text-white mt-2">${h.label}</dt><dd class="text-slate-300">${h.value}</dd>`).join('')}
                        ${benefitsHtml}
                    </dl>
                `;
            }

            const sections = [
                ...(highlightsContent ? [{ title: 'Key Features', content: highlightsContent, isHtml: true }] : []),
                { title: 'Usage Instructions', content: product.usageInfo },
                { title: 'Ingredients', content: product.ingredients },
                { title: 'Manufacturer Info', content: product.manufacturerInfo },
                { title: 'Additional Information', content: product.additionalInfo },
                { title: 'Disclaimer', content: product.disclaimer }
            ];

            const availableSections = sections.filter(section => section.content && section.content.trim() !== '');
            
            const returnPolicyHTML = `
                <div class="bg-slate-800 rounded-lg border border-slate-700">
                    <button class="info-accordion-question w-full flex justify-between items-center text-left p-5">
                        <span class="text-lg font-semibold text-white">Return Policy</span>
                        <i data-lucide="chevron-down" class="accordion-icon text-cyan-400 transition-transform duration-300"></i>
                    </button>
                    <div class="info-accordion-answer px-5 pb-5 text-slate-300">
                        <div class="mb-4">
                            <h4 class="font-semibold text-green-400">Refundable Conditions</h4>
                            <ul class="list-disc list-inside text-slate-300 mt-2 space-y-1 text-sm">
                                <li>Return requested within 7 days of delivery.</li>
                                <li>Product must be in its original, unopened condition.</li>
                                <li>The factory seal and shrink-wrap must be intact.</li>
                                <li>You will need the receipt or proof of purchase.</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold text-red-400">Non-Refundable Conditions</h4>
                            <ul class="list-disc list-inside text-slate-300 mt-2 space-y-1 text-sm">
                                <li>If the product's safety seal is broken, opened, or tampered with.</li>
                                <li>If the return is requested after 7 days of delivery.</li>
                                <li>Items purchased during clearance sales or special promotions.</li>
                                <li>Products without their original packaging.</li>
                            </ul>
                        </div>
                        <p class="mt-4 text-xs text-slate-400">Please refer to our full <a href="#return-policy" class="underline">Return Policy page</a> for more details on initiating a return.</p>
                    </div>
                </div>
            `;

            if (availableSections.length === 0) {
                accordionContainer.innerHTML = `<div class="space-y-3">${returnPolicyHTML}</div>`;
                lucide.createIcons();
                return;
            }

            const accordionHTML = availableSections.map(section => `
                <div class="bg-slate-800 rounded-lg border border-slate-700">
                    <button class="info-accordion-question w-full flex justify-between items-center text-left p-5">
                        <span class="text-lg font-semibold text-white">${section.title}</span>
                        <i data-lucide="chevron-down" class="accordion-icon text-cyan-400 transition-transform duration-300"></i>
                    </button>
                    <div class="info-accordion-answer px-5 pb-5 text-slate-300 prose prose-invert max-w-none">
                        ${section.isHtml ? section.content : `<p>${section.content.replace(/\n/g, '<br>')}</p>`}
                    </div>
                </div>
            `).join('');

            accordionContainer.innerHTML = `<div class="space-y-3">${accordionHTML}${returnPolicyHTML}</div>`;
            lucide.createIcons();
        };

        const renderReviews = async (productId) => {
             const reviewsRef = collection(db, `products/${productId}/reviews`);
            onSnapshot(query(reviewsRef, orderBy('timestamp', 'desc')), (snapshot) => {
                const reviews = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                const avgRating = reviews.length ? (reviews.reduce((acc, r) => acc + r.rating, 0) / reviews.length).toFixed(1) : 'No reviews';
                const reviewsListHtml = reviews.length ? reviews.map(review => `
                    <div class="py-4 border-b border-slate-700">
                        <div class="flex items-center mb-2">
                           ${[...Array(5)].map((_, i) => `<i data-lucide="star" class="w-5 h-5 ${i < review.rating ? 'fill-cyan-400 text-cyan-400' : 'text-slate-600'}"></i>`).join('')}
                           <p class="ml-3 font-semibold text-white">${review.authorName}</p>
                        </div>
                        <p class="text-slate-300">${review.text}</p>
                    </div>
                `).join('') : '<p class="text-slate-400">No reviews yet. Be the first to write one!</p>';

                DOMElements.reviewsSection.innerHTML = `
                    <h2 class="text-3xl font-bold text-white mb-2">Customer Reviews</h2>
                    <div class="flex items-center gap-2 mb-8"><i data-lucide="star" class="w-6 h-6 text-cyan-400 fill-cyan-400"></i><span class="text-2xl font-bold">${avgRating}</span><span class="text-slate-400">(${reviews.length} reviews)</span></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                        <div class="bg-slate-800/50 p-6 rounded-lg border border-slate-700">
                            <h3 class="text-xl font-semibold mb-4">Write a Review</h3>
                            <form id="add-review-form" class="space-y-4">
                                <input type="hidden" id="reviewProductId" value="${productId}">
                                <div><label class="block text-sm font-medium text-slate-300">Your Name</label><input type="text" id="reviewAuthor" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required></div>
                                <div><label class="block text-sm font-medium text-slate-300">Rating</label>
                                    <div class="star-rating-input">
                                        <input type="radio" name="rating" id="star-5" value="5" required/><label for="star-5">★</label><input type="radio" name="rating" id="star-4" value="4"/><label for="star-4">★</label><input type="radio" name="rating" id="star-3" value="3"/><label for="star-3">★</label><input type="radio" name="rating" id="star-2" value="2"/><label for="star-2">★</label><input type="radio" name="rating" id="star-1" value="1"/><label for="star-1">★</label>
                                    </div>
                                </div>
                                <div><label class="block text-sm font-medium text-slate-300">Review</label><textarea id="reviewText" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required></textarea></div>
                                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 font-bold py-2 px-4 rounded-lg">Submit Review</button>
                            </form>
                        </div>
                        <div> <h3 class="text-xl font-semibold mb-4">All Reviews</h3><div class="space-y-4 max-h-96 overflow-y-auto no-scrollbar">${reviewsListHtml}</div></div>
                    </div>`;
                lucide.createIcons();
            });
        };
        
        const renderRelatedProducts = (currentProduct) => {
            const relatedProductsSection = document.getElementById('related-products-section');
            const related = allProducts.filter(p => p.category === currentProduct.category && p.id !== currentProduct.id).slice(0, 4);
            if (related.length > 0) {
                 relatedProductsSection.innerHTML = `
                    <h2 class="text-3xl font-bold text-white mb-8">You Might Also Like</h2>
                    <div id="related-products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8"></div>
                `;
                renderProductGrid(related, document.getElementById('related-products-grid'));
            } else {
                relatedProductsSection.innerHTML = '';
            }
        };

        const renderCustomerOrders = (orders) => {
            const listEl = DOMElements.customerOrderList;
            listEl.innerHTML = '';
            if (!orders || orders.length === 0) {
                listEl.innerHTML = '<p class="text-slate-400 text-center">No orders found.</p>';
                return;
            }

            orders.forEach(order => {
                const item = document.createElement('div');
                item.className = "bg-slate-800 p-4 rounded-lg";
                const orderDate = order.timestamp?.toDate().toLocaleString() || 'N/A';
                const itemsHtml = order.items.map(p => `<li>${p.name} (${p.size}, ${p.flavour}) x${p.quantity}</li>`).join('');
                const paymentStatusColor = order.paymentStatus === 'paid' ? 'text-green-400' : 'text-yellow-400';
                const statusColor = {
                    'Pending': 'text-yellow-400',
                    'Shipped': 'text-blue-400',
                    'Delivered': 'text-green-400',
                    'Cancelled': 'text-red-400',
                }[order.status] || 'text-slate-400';
                
                const trackingHtml = (order.status === 'Shipped' && order.courierName && order.trackingNumber) ?
                    `<p class="text-sm mt-2"><span class="font-semibold text-slate-400">Tracking:</span> <span class="text-slate-300">${order.courierName} - ${order.trackingNumber}</span></p>` : '';

                item.innerHTML = `
                    <div class="flex flex-wrap justify-between items-start gap-4">
                        <div>
                            <p class="font-bold text-white">Order ID: ${order.id.substring(0, 8)}</p>
                            <p class="text-sm text-slate-400">${orderDate}</p>
                        </div>
                         <div class="text-right">
                            <p class="text-xl font-bold text-cyan-400">₹${order.total.toLocaleString('en-IN')}</p>
                            <p class="text-sm font-semibold ${paymentStatusColor}">${order.paymentMethod === 'cod' ? 'COD' : 'Paid'}</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-600">
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-cyan-400 mb-2">Items</p>
                            <p class="font-bold ${statusColor}">${order.status}</p>
                        </div>
                        <ul class="list-disc list-inside text-slate-300 text-sm space-y-1">${itemsHtml}</ul>
                        ${trackingHtml}
                        <p class="text-sm mt-2"><span class="font-semibold text-slate-400">Address:</span> <span class="text-slate-300">${order.deliveryType === 'pickup' ? 'In-Store Pickup' : order.customer.address}</span></p>
                    </div>
                `;
                listEl.appendChild(item);
            });
        };

        const renderPaginationControls = (totalProducts) => {
            DOMElements.paginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalProducts / productsPerPage);
            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.className = 'bg-slate-700 hover:bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; filterAndRenderProducts(); } });
            DOMElements.paginationControls.appendChild(prevButton);

            const pageIndicator = document.createElement('span');
            pageIndicator.textContent = `Page ${currentPage} of ${totalPages}`;
            pageIndicator.className = 'text-slate-400 font-semibold px-4';
            DOMElements.paginationControls.appendChild(pageIndicator);

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.className = 'bg-slate-700 hover:bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; filterAndRenderProducts(); } });
            DOMElements.paginationControls.appendChild(nextButton);
        };

        const filterAndRenderProducts = () => {
            let filteredProducts = [...allProducts];

            switch (currentSort) {
                case 'price-asc': filteredProducts.sort((a, b) => (a.minPrice || Infinity) - (b.minPrice || Infinity)); break;
                case 'price-desc': filteredProducts.sort((a, b) => (b.minPrice || 0) - (a.minPrice || 0)); break;
                case 'rating-desc': filteredProducts.sort((a, b) => (b.avgRating || 0) - (a.avgRating || 0)); break;
            }
            
            if (currentCategory !== 'All') filteredProducts = filteredProducts.filter(p => p.category === currentCategory);
            if (currentSearchTerm) filteredProducts = filteredProducts.filter(p => p.name.toLowerCase().includes(currentSearchTerm));
            if (currentBrand !== 'All') filteredProducts = filteredProducts.filter(p => p.brand === currentBrand);
            if (currentGoal !== 'All') filteredProducts = filteredProducts.filter(p => p.goals && p.goals.includes(currentGoal));
            
            const startIndex = (currentPage - 1) * productsPerPage;
            const paginatedProducts = filteredProducts.slice(startIndex, startIndex + productsPerPage);

            renderProductGrid(paginatedProducts, DOMElements.productGrid);
            renderPaginationControls(filteredProducts.length);
        };

        const renderCategoryCards = () => {
            const grid = document.getElementById('category-card-grid');
            if (!grid) return;

            const categories = [
                { name: 'Protein', image: 'https://images.unsplash.com/photo-1579758629938-03607ccdbaba?q=80&w=2070&auto=format&fit=crop' },
                { name: 'Mass Gainer', image: 'https://images.unsplash.com/photo-1574680096145-d05b474e2155?q=80&w=2069&auto=format&fit=crop' },
                { name: 'Pre-Workout', image: 'https://images.unsplash.com/photo-1599058917212-d750089bc07e?q=80&w=2069&auto=format&fit=crop' },
                { name: 'Vitamins', image: 'https://images.unsplash.com/photo-1607532941433-304659e8198a?q=80&w=1978&auto=format&fit=crop' }
            ];

            grid.innerHTML = categories.map((cat, index) => `
                <div class="category-photo-card rounded-lg shadow-lg cursor-pointer aspect-square animate-on-scroll fade-in-up" style="transition-delay: ${index * 100}ms" data-category="${cat.name}">
                    <img src="${cat.image}" class="w-full h-full object-cover rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/400x400/1e293b/FFFFFF?text=${encodeURIComponent(cat.name)}';">
                    <div class="absolute inset-0 bg-black/60 flex items-center justify-center rounded-lg">
                        <h3 class="overlay-text text-white text-2xl font-bold tracking-wider">${cat.name}</h3>
                    </div>
                </div>
            `).join('');
        };

        const renderCategoryFilters = () => {
            const categories = ['All', ...new Set(allProducts.map(p => p.category))];
            DOMElements.categoryFilters.innerHTML = categories.map(cat => `<button class="category-btn text-slate-300 bg-slate-800/50 hover:bg-slate-700 font-semibold py-2 px-4 rounded-lg transition duration-300 border border-slate-600 ${cat === 'All' ? 'active' : ''}" data-category="${cat}">${cat}</button>`).join('');
        };

        const renderAdvancedFilters = () => {
            const brands = ['All', ...new Set(allProducts.map(p => p.brand).filter(Boolean).sort())];
            const goals = ['All', ...new Set(allProducts.flatMap(p => p.goals || []).filter(Boolean).sort())];
            
            const brandSelect = document.getElementById('brand-filter');
            brandSelect.innerHTML = brands.map(b => `<option value="${b}">${b}</option>`).join('');

            const goalSelect = document.getElementById('goal-filter');
            goalSelect.innerHTML = goals.map(g => `<option value="${g}">${g}</option>`).join('');
        };
        
        const renderAdminProducts = (products) => {
            DOMElements.adminProductList.innerHTML = '';
            if (products.length === 0) { DOMElements.adminProductList.innerHTML = `<p class="text-slate-400 text-center">No products found.</p>`; return; }
            products.forEach(product => {
                const item = document.createElement('div');
                item.className = "bg-slate-700 p-4 rounded-lg flex items-center justify-between gap-4";
                item.innerHTML = `
                    <div class="flex items-center gap-4 flex-grow"><img src="${product.imageUrl}" alt="${product.name}" class="w-16 h-16 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64/1e293b/FFFFFF?text=Img';">
                        <div class="flex-grow">
                            <p class="font-semibold text-white">${product.name}</p>
                            <p class="text-sm text-slate-400">${product.brand || 'No Brand'}</p>
                            <p class="text-sm text-slate-400">${product.category}</p>
                            <p class="text-xs text-cyan-400">${product.variantCount} variants - ${product.totalStock} in stock</p>
                            ${product.isFeatured ? '<span class="text-xs font-bold text-cyan-400">FEATURED</span>' : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button data-id="${product.id}" class="manage-variants-btn bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded-lg">Manage Variants</button>
                        <button data-id="${product.id}" class="edit-product-btn text-slate-300 hover:text-white"><i data-lucide="edit"></i></button>
                        <button data-id="${product.id}" class="delete-product-btn text-red-400 hover:text-red-500"><i data-lucide="trash-2"></i></button>
                    </div>`;
                DOMElements.adminProductList.appendChild(item);
            });
            lucide.createIcons();
        };

        const renderAdminOrders = (orders, targetElement) => {
            if (!targetElement) return;
            targetElement.innerHTML = '';
            if (orders.length === 0) {
                targetElement.innerHTML = `<p class="text-slate-400 text-center">No orders match the current filter.</p>`;
                return;
            }
            orders.forEach(order => {
                const item = document.createElement('div');
                item.className = "bg-slate-700 p-4 rounded-lg";
                const orderDate = order.timestamp?.toDate().toLocaleString() || 'N/A';
                const itemsHtml = order.items.map(p => `<li>${p.name} (${p.size}, ${p.flavour}) x${p.quantity}</li>`).join('');
                
                const trackingInfoHTML = order.status === 'Shipped' ? `
                    <div class="mt-4 pt-4 border-t border-slate-600">
                        <div class="flex gap-2 items-end">
                            <div class="flex-grow"><label class="text-xs text-slate-400">Courier</label><input type="text" value="${order.courierName || ''}" class="courier-name-input w-full bg-slate-800 rounded px-2 py-1 text-sm" placeholder="e.g., Delhivery"></div>
                            <div class="flex-grow"><label class="text-xs text-slate-400">Tracking #</label><input type="text" value="${order.trackingNumber || ''}" class="tracking-number-input w-full bg-slate-800 rounded px-2 py-1 text-sm" placeholder="Tracking ID"></div>
                            <button class="save-tracking-btn bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-1 px-3 rounded text-sm" data-id="${order.id}">Save</button>
                        </div>
                    </div>` : '';

                const paymentStatusColor = order.paymentStatus === 'paid' ? 'text-green-400' : 'text-yellow-400';

                item.innerHTML = `
                    <div class="flex flex-wrap justify-between items-start gap-4">
                        <div>
                            <p class="font-bold text-white">Order ID: ${order.id.substring(0, 8)}</p>
                            <p class="text-sm text-slate-400">${orderDate}</p>
                        </div>
                         <div class="text-right">
                            <p class="text-xl font-bold text-cyan-400">₹${order.total.toLocaleString('en-IN')}</p>
                            <p class="text-sm font-semibold ${paymentStatusColor}">${order.paymentMethod === 'cod' ? 'COD' : 'Paid'} ${order.couponUsed ? `(${order.couponUsed})` : ''}</p>
                            <select class="order-status-select bg-slate-800 border-slate-600 rounded-md shadow-sm text-white px-3 py-1 mt-2" data-id="${order.id}">
                                <option ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option ${order.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                                <option ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                <option ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-600 grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <p class="font-semibold text-cyan-400 mb-2">Customer Details</p>
                            <p class="text-sm font-semibold text-white">${order.customer.name}</p>
                            <p class="text-sm text-slate-300">${order.customer.email}</p>
                            <p class="text-sm text-slate-300">${order.customer.phone}</p>
                            <p class="text-sm mt-2"><span class="font-semibold text-slate-400">Address:</span> <span class="text-slate-300">${order.deliveryType === 'pickup' ? 'In-Store Pickup' : order.customer.address}</span></p>
                            ${order.customer.liveLocation ? `<p class="text-sm mt-2"><span class="font-semibold text-slate-400">Live Location:</span> <a href="https://www.google.com/maps?q=...{order.customer.liveLocation.lat},${order.customer.liveLocation.lon}" target="_blank" class="text-cyan-400 underline hover:text-cyan-300">Open in Google Maps</a></p>` : ''}
                        </div>
                        <div>
                            <p class="font-semibold text-cyan-400 mb-2">Items</p>
                            <ul class="list-disc list-inside text-slate-300 text-sm">${itemsHtml}</ul>
                        </div>
                    </div>
                    ${trackingInfoHTML}
                `;
                targetElement.appendChild(item);
            });
        };

        const switchAdminTab = (tab) => {
            // Deactivate all tabs and hide all content
            ['dashboard', 'products', 'orders', 'daily-orders', 'coupons', 'subscribers', 'settings'].forEach(t => {
                const tabBtn = document.getElementById(`tab-${t}`);
                const contentEl = document.getElementById(`content-${t}`);
                if (tabBtn) {
                    tabBtn.classList.remove('text-cyan-400', 'border-cyan-400');
                    tabBtn.classList.add('text-slate-400', 'hover:text-white');
                }
                if (contentEl) {
                    contentEl.classList.add('hidden');
                }
            });

            // Activate the selected tab and show its content
            const activeTab = document.getElementById(`tab-${tab}`);
            if (activeTab) {
                activeTab.classList.add('text-cyan-400', 'border-cyan-400');
                activeTab.classList.remove('text-slate-400', 'hover:text-white');
            }
            const activeContent = document.getElementById(`content-${tab}`);
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }
        };

        const renderAdminCoupons = (coupons) => {
             DOMElements.adminCouponList.innerHTML = '';
            if (coupons.length === 0) { DOMElements.adminCouponList.innerHTML = `<p class="text-slate-400 text-center">No coupons found.</p>`; return; }
            coupons.forEach(coupon => {
                const item = document.createElement('div');
                item.className = "bg-slate-700 p-3 rounded-lg flex justify-between items-center";
                const discountText = coupon.discountType === 'percent' ? `${coupon.value}% off` : `₹${coupon.value} off`;
                item.innerHTML = `<div><p class="font-bold text-lg text-cyan-400">${coupon.id}</p><p class="text-slate-300">${discountText}</p></div><button data-id="${coupon.id}" class="delete-coupon-btn text-red-400 hover:text-red-500"><i data-lucide="trash-2"></i></button>`;
                DOMElements.adminCouponList.appendChild(item);
            });
            lucide.createIcons();
        }

        const renderAdminSubscribers = (subscribers) => {
            DOMElements.adminSubscriberList.innerHTML = '';
            if (subscribers.length === 0) {
                DOMElements.adminSubscriberList.innerHTML = `<p class="text-slate-400 text-center">No subscribers yet.</p>`;
                return;
            }
            subscribers.forEach(sub => {
                const item = document.createElement('div');
                item.className = 'bg-slate-700 p-3 rounded-lg flex justify-between items-center';
                item.innerHTML = `<p class="text-white">${sub.email}</p><span class="text-xs text-slate-400">${sub.subscribedAt?.toDate().toLocaleDateString() || ''}</span>`;
                DOMElements.adminSubscriberList.appendChild(item);
            });
        };

        const renderSkeletons = () => { 
            const skeletonCard = `
                <div class="skeleton-card">
                    <div class="h-48 shimmer-bg"></div>
                    <div class="h-6 shimmer-bg"></div>
                    <div class="h-4 shimmer-bg w-1-3"></div>
                    <div class="h-4 shimmer-bg w-1-2"></div>
                    <div class="h-8 shimmer-bg"></div>
                </div>`;
            DOMElements.productGrid.innerHTML = Array(8).fill(skeletonCard).join(''); 
        };
        
        const calculateDashboardStats = (orders, products) => {
            const totalRevenue = orders.reduce((acc, order) => acc + order.total, 0);
            document.getElementById('stats-total-revenue').textContent = `₹${totalRevenue.toLocaleString('en-IN')}`;

            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentOrders = orders.filter(o => o.timestamp && o.timestamp.toDate() > thirtyDaysAgo);
            document.getElementById('stats-orders-30d').textContent = recentOrders.length;
            
            document.getElementById('stats-total-products').textContent = products.length;

            const productSales = {};
            orders.forEach(order => {
                order.items.forEach(item => {
                    productSales[item.name] = (productSales[item.name] || 0) + item.quantity;
                });
            });
            const topProducts = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const topProductsEl = document.getElementById('stats-top-products');
            topProductsEl.innerHTML = topProducts.length ? topProducts.map(([name, qty]) => `<div class="flex justify-between text-slate-300"><p>${name}</p><p class="font-bold">${qty} sold</p></div>`).join('') : '<p class="text-slate-400">Not enough sales data.</p>';
        };


        // --- UTILITY FUNCTIONS ---
        const fetchAddressFromCoords = async (lat, lon) => {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                if (!response.ok) {
                    throw new Error(`Reverse geocoding failed with status: ${response.status}`);
                }
                const data = await response.json();
                if (data && data.address) {
                    const addr = data.address;
                    const addressLine1 = [addr.road, addr.neighbourhood, addr.suburb].filter(Boolean).join(', ');
                    
                    document.getElementById('customerAddress1').value = addressLine1 || data.display_name || '';
                    document.getElementById('customerCity').value = addr.city || addr.town || addr.village || '';
                    document.getElementById('customerState').value = addr.state || '';
                    document.getElementById('customerPincode').value = addr.postcode || '';
                    
                    showToast('Address fields have been pre-filled.');
                    document.getElementById('location-info').innerHTML = `<span class="text-green-400">✅ Address pre-filled successfully!</span>`;
                } else {
                     throw new Error('No address found for these coordinates.');
                }
            } catch (error) {
                console.error("Reverse geocoding error:", error);
                showToast("Could not auto-fill address. Please enter manually.", true);
                document.getElementById('location-info').innerHTML = `<span class="text-yellow-400">✅ Location captured (could not fetch address).</span>`;
            }
        };

        const compressImage = (file, options = { maxWidth: 1024, quality: 0.8 }) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                // Use createObjectURL for better memory management with large files
                const objectUrl = URL.createObjectURL(file);

                img.onload = () => {
                    // Clean up the object URL once the image is loaded
                    URL.revokeObjectURL(objectUrl);

                    const canvas = document.createElement('canvas');
                    let { width, height } = img;

                    if (width > height) {
                        if (width > options.maxWidth) {
                            height = Math.round((height * options.maxWidth) / width);
                            width = options.maxWidth;
                        }
                    } else {
                        if (height > options.maxWidth) {
                            width = Math.round((width * options.maxWidth) / height);
                            height = options.maxWidth;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(
                        (blob) => {
                            if (blob) {
                                const newFile = new File([blob], `${Date.now()}-compressed.jpeg`, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now(),
                                });
                                resolve(newFile);
                            } else {
                                reject(new Error('Canvas to Blob conversion failed. The image might be corrupt.'));
                            }
                        },
                        'image/jpeg',
                        options.quality
                    );
                };

                img.onerror = () => {
                    URL.revokeObjectURL(objectUrl);
                    reject(new Error('Failed to load image. It may be corrupt or an unsupported format.'));
                };

                img.src = objectUrl;
            });
        };


        // --- DATABASE INTERACTIONS ---
        const setupAdminOrdersListener = () => {
            if (ordersListener) return;
            const ordersQuery = query(ordersCollection, orderBy("timestamp", "desc")); 
            ordersListener = onSnapshot(ordersQuery, (snapshot) => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminOrders(allOrders, DOMElements.adminOrderList);
                calculateDashboardStats(allOrders, allProducts);
            }, (error) => {
                console.error("Error listening to orders collection.", error);
                DOMElements.adminOrderList.innerHTML = `<p class="text-red-400 p-4 text-center">Error: Could not load orders. Please check Firestore security rules.</p>`;
            });
        };

        const setupAdminDailyOrdersListener = () => {
            if (dailyOrdersListener) return;

            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
            const endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
            
            DOMElements.todayDateSpan.textContent = now.toLocaleDateString('en-IN', { dateStyle: 'long' });

            const dailyOrdersQuery = query(ordersCollection, where("timestamp", ">=", startOfToday), where("timestamp", "<=", endOfToday));
            dailyOrdersListener = onSnapshot(dailyOrdersQuery, (snapshot) => {
                const dailyOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                dailyOrders.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderAdminOrders(dailyOrders, DOMElements.adminDailyOrderList);
            }, (error) => {
                console.error("Error listening to daily orders.", error);
                DOMElements.adminDailyOrderList.innerHTML = `<p class="text-red-400 p-4 text-center">Error: Could not load today's orders.</p>`;
            });
        };

        const detachAdminOrdersListener = () => {
            if (ordersListener) {
                ordersListener(); 
                ordersListener = null;
            }
            if (dailyOrdersListener) {
                dailyOrdersListener();
                dailyOrdersListener = null;
            }
        };
        
        const saveBannerSettings = async (settings) => { try { await setDoc(doc(db, 'site_settings', 'banner'), settings); showToast('Banner settings saved!'); } catch (e) { console.error(e); showToast('Failed to save settings.', true); } };
        
        const saveProduct = async (productData, id) => {
            try {
                if (id) {
                    await setDoc(doc(db, 'products', id), productData, { merge: true });
                } else {
                    const docRef = await addDoc(collection(db, 'products'), productData);
                    id = docRef.id;
                }

                // Handle file uploads
                if (imageFilesToUpload.length > 0) {
                    showToast(`Compressing ${imageFilesToUpload.length} image(s)...`);
                    
                    const compressedFiles = await Promise.all(
                        imageFilesToUpload.map(file => compressImage(file))
                    );

                    showToast(`Uploading ${compressedFiles.length} image(s)...`);

                    const uploadPromises = compressedFiles.map(file => {
                        const filePath = `product_images/${id}/${file.name}`;
                        const storageRef = ref(storage, filePath);
                        return uploadBytes(storageRef, file).then(snapshot => getDownloadURL(snapshot.ref));
                    });

                    const newUrls = await Promise.all(uploadPromises);
                    const existingUrls = productData.imageUrls || [];
                    const finalImageUrls = [...existingUrls, ...newUrls];

                    await updateDoc(doc(db, 'products', id), { 
                        imageUrls: finalImageUrls,
                        imageUrl: finalImageUrls[0] || ''
                    });
                }
                
                showToast(`Product ${id ? 'updated' : 'added'} successfully!`);
                closeAdminProductModal();
            } catch (e) {
                console.error("Error saving product:", e);
                showToast(`Failed to save product. Error: ${e.message}`, true);
            } finally {
                showLoading(false);
            }
        };


        const deleteProduct = async (productId) => { try { const variantsRef = collection(db, `products/${productId}/variants`); const variantSnapshot = await getDocs(variantsRef); const batch = writeBatch(db); variantSnapshot.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); await deleteDoc(doc(db, 'products', productId)); showToast('Product and its variants deleted successfully!'); } catch (e) { console.error(e); showToast('Failed to delete product.', true); } };
        const saveVariant = async (productId, variantData) => { try { const docRef = doc(collection(db, `products/${productId}/variants`)); await setDoc(docRef, { ...variantData, price: Number(variantData.price), salePrice: Number(variantData.salePrice) || null, quantity: Number(variantData.quantity) }); showToast(`Variant added successfully!`); openAdminVariantModal(productId); } catch(e) { console.error(e); showToast('Failed to save variant.', true); } };
        const deleteVariant = async (productId, variantId) => { try { await deleteDoc(doc(db, `products/${productId}/variants`, variantId)); showToast('Variant deleted successfully!'); openAdminVariantModal(productId); } catch (e) { console.error(e); showToast('Failed to delete variant.', true); } };
        const addReview = async (productId, reviewData) => { try { const reviewRef = collection(db, `products/${productId}/reviews`); await addDoc(reviewRef, reviewData); showToast('Thank you for your review!'); } catch(e) { console.error(e); showToast('Could not submit review.', true); } };
        const saveCoupon = async (couponData) => { try { const docRef = doc(db, 'coupons', couponData.code.toUpperCase()); await setDoc(docRef, { discountType: couponData.discountType, value: Number(couponData.value) }); showToast('Coupon added successfully!'); } catch (e) { console.error(e); showToast('Failed to add coupon.', true); } };
        const deleteCoupon = async (couponId) => { try { await deleteDoc(doc(db, 'coupons', couponId)); showToast('Coupon deleted successfully!'); } catch (e) { console.error(e); showToast('Failed to delete coupon.', true); } };
        const updateOrderStatusAndTracking = async (id, data) => { try { const orderRef = doc(db, ordersCollection.path, id); await updateDoc(orderRef, data); showToast('Order updated successfully!'); } catch (e) { console.error(e); showToast('Failed to update order.', true); }};
        const subscribeToNewsletter = async (email) => { try { await setDoc(doc(db, 'subscribers', email), { email, subscribedAt: serverTimestamp() }); showToast('Thank you for subscribing!'); } catch (e) { console.error(e); showToast('Could not subscribe. Please try again.', true); }};

        // --- ADMIN MODALS ---
        const openAdminProductModal = (product = null) => {
            imageFilesToUpload = []; // Reset file list
            const modal = document.getElementById('admin-product-modal');
            
            modal.innerHTML = `
                <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 rounded-lg shadow-xl w-full max-w-2xl p-8 relative no-scrollbar overflow-y-auto max-h-screen">
                    <button id="close-product-modal" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
                    <h2 class="text-2xl font-bold text-cyan-400 mb-6">${product ? 'Edit Product' : 'Add New Product'}</h2>
                    <form id="add-product-form" class="space-y-4">
                        <input type="hidden" id="productId" value="${product?.id || ''}">
                        <div><label for="productName" class="block text-sm font-medium text-slate-300">Product Name</label><input type="text" id="productName" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" value="${product?.name || ''}" required></div>
                        <div><label for="productBrand" class="block text-sm font-medium text-slate-300">Brand</label><input type="text" id="productBrand" placeholder="e.g., Optimum Nutrition" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" value="${product?.brand || ''}" required></div>
                        <div><label for="productDescription" class="block text-sm font-medium text-slate-300">Short Description</label><textarea id="productDescription" rows="2" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required>${product?.description || ''}</textarea></div>
                        
                        <div>
                            <label for="productImageFiles" class="block text-sm font-medium text-slate-300">Product Images</label>
                            <input type="file" id="productImageFiles" multiple accept="image/*" class="mt-1 w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-100 file:text-cyan-700 hover:file:bg-cyan-200">
                            <div class="flex gap-2 mt-2">
                                <input type="url" id="productImageUrlInput" placeholder="Or add image by URL" class="flex-grow bg-slate-600 border border-slate-500 rounded-md text-white px-3 py-2 text-sm focus:ring-cyan-500 focus:border-cyan-500">
                                <button type="button" id="add-image-url-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg text-sm">Add URL</button>
                            </div>
                            <div id="image-preview-container" class="mt-4 grid grid-cols-4 gap-4"></div>
                        </div>

                        <div><label for="productCategory" class="block text-sm font-medium text-slate-300">Category</label><select id="productCategory" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required><option>Protein</option><option>Mass Gainer</option><option>Creatine</option><option>Pre-Workout</option><option>Vitamins</option><option>Other</option></select></div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-300">Goals</label>
                            <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2">
                                <label class="flex items-center"><input type="checkbox" class="goal-checkbox bg-slate-600" value="Muscle Gain" ${product?.goals?.includes('Muscle Gain') ? 'checked' : ''}> <span class="ml-2 text-sm">Muscle Gain</span></label>
                                <label class="flex items-center"><input type="checkbox" class="goal-checkbox bg-slate-600" value="Weight Loss" ${product?.goals?.includes('Weight Loss') ? 'checked' : ''}> <span class="ml-2 text-sm">Weight Loss</span></label>
                                <label class="flex items-center"><input type="checkbox" class="goal-checkbox bg-slate-600" value="Endurance" ${product?.goals?.includes('Endurance') ? 'checked' : ''}> <span class="ml-2 text-sm">Endurance</span></label>
                                <label class="flex items-center"><input type="checkbox" class="goal-checkbox bg-slate-600" value="Wellness" ${product?.goals?.includes('Wellness') ? 'checked' : ''}> <span class="ml-2 text-sm">Wellness</span></label>
                            </div>
                        </div>

                        <div class="border-t border-slate-700 pt-4">
                            <h3 class="text-lg font-semibold text-slate-200 mb-2">Key Features</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label for="productPricePerServing" class="block text-sm font-medium text-slate-300">Price Per Serving (₹)</label><input type="text" id="productPricePerServing" placeholder="e.g., 15.1" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" value="${product?.pricePerServing || ''}"></div>
                                <div><label for="productForm" class="block text-sm font-medium text-slate-300">Form</label><input type="text" id="productForm" placeholder="e.g., Powder" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" value="${product?.form || ''}"></div>
                            </div>
                            <div><label for="productPackaging" class="block text-sm font-medium text-slate-300 mt-4">Packaging Type</label><input type="text" id="productPackaging" placeholder="e.g., Jar" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" value="${product?.packaging || ''}"></div>
                            <div><label for="productBenefits" class="block text-sm font-medium text-slate-300 mt-4">Benefits (comma-separated)</label><textarea id="productBenefits" rows="2" placeholder="e.g., Energy, Build Muscle, Strength" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2">${(product?.benefits && Array.isArray(product.benefits)) ? product.benefits.join(', ') : ''}</textarea></div>
                        </div>

                        <div class="border-t border-slate-700 pt-4">
                             <h3 class="text-lg font-semibold text-slate-200 mb-2">Additional Details</h3>
                            <div><label for="productUsageInfo" class="block text-sm font-medium text-slate-300">Usage Instructions</label><textarea id="productUsageInfo" rows="3" placeholder="How to use this product..." class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2">${product?.usageInfo || ''}</textarea></div>
                            <div class="mt-4"><label for="productIngredients" class="block text-sm font-medium text-slate-300">Ingredients</label><textarea id="productIngredients" rows="3" placeholder="List all ingredients..." class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2">${product?.ingredients || ''}</textarea></div>
                            <div class="mt-4"><label for="productManufacturerInfo" class="block text-sm font-medium text-slate-300">Manufacturer Info</label><textarea id="productManufacturerInfo" rows="2" placeholder="e.g., 'Manufactured by Brand Inc., Country'" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2">${product?.manufacturerInfo || ''}</textarea></div>
                            <div class="mt-4"><label for="productAdditionalInfo" class="block text-sm font-medium text-slate-300">Additional Information</label><textarea id="productAdditionalInfo" rows="3" placeholder="Any other relevant info..." class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2">${product?.additionalInfo || ''}</textarea></div>
                            <div class="mt-4"><label for="productDisclaimer" class="block text-sm font-medium text-slate-300">Disclaimer</label><textarea id="productDisclaimer" rows="2" placeholder="e.g., 'Nutritional values may differ...'" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2">${product?.disclaimer || ''}</textarea></div>
                        </div>
                        
                        <div class="pt-4"><div class="flex items-center"><input type="checkbox" id="productIsFeatured" class="h-4 w-4 rounded" ${product?.isFeatured ? 'checked' : ''}><label for="productIsFeatured" class="ml-2 block text-sm text-slate-300">Feature this product on homepage</label></div></div>
                        <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg transition duration-300">${product ? 'Save Changes' : 'Add Product'}</button>
                    </form>
                </div>`;
            if (product) document.getElementById('productCategory').value = product.category;

            const imagePreviewContainer = modal.querySelector('#image-preview-container');
            if (product && product.imageUrls) {
                renderImagePreviews(product.imageUrls, imagePreviewContainer);
            }
            modal.querySelector('#productImageFiles').addEventListener('change', (e) => {
                const newFiles = Array.from(e.target.files);
                // Prevent duplicates
                newFiles.forEach(file => {
                    if (!imageFilesToUpload.some(existingFile => existingFile.name === file.name)) {
                        imageFilesToUpload.push(file);
                    }
                });

                const filePreviews = imageFilesToUpload.map(file => ({ url: URL.createObjectURL(file), name: file.name }));
                
                const existingUrlElements = Array.from(document.querySelectorAll('#image-preview-container [data-url]'));
                const existingHttpUrls = existingUrlElements.map(el => el.dataset.url).filter(url => url.startsWith('http'));

                renderImagePreviews([...existingHttpUrls, ...filePreviews], imagePreviewContainer);
            });
            
            modal.querySelector('#add-image-url-btn').addEventListener('click', () => {
                const urlInput = modal.querySelector('#productImageUrlInput');
                const newUrl = urlInput.value.trim();
                if (newUrl) {
                    try {
                        new URL(newUrl); // Basic validation
                        const existingUrls = Array.from(document.querySelectorAll('#image-preview-container [data-url]')).map(el => el.dataset.url);
                        if (!existingUrls.includes(newUrl)) {
                            renderImagePreviews([...existingUrls, newUrl], imagePreviewContainer);
                            urlInput.value = '';
                        } else {
                            showToast('Image URL has already been added.', true);
                        }
                    } catch (err) {
                        showToast('Please enter a valid image URL.', true);
                    }
                }
            });


            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        };

        const renderImagePreviews = (urls, container, isFile = false) => {
            container.innerHTML = urls.map((item) => {
                const url = typeof item === 'string' ? item : item.url;
                const nameAttr = typeof item === 'object' ? `data-filename="${item.name}"` : '';

                return `
                    <div class="relative group">
                        <img src="${url}" class="w-full h-24 object-cover rounded-md">
                        <button type="button" data-url="${url}" ${nameAttr} class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity remove-image-btn">
                            <i data-lucide="x" class="w-3 h-3 pointer-events-none"></i>
                        </button>
                    </div>
                `
            }).join('');
            lucide.createIcons();
        };

        const closeAdminProductModal = () => document.getElementById('admin-product-modal').classList.add('hidden');

        const openAdminVariantModal = async (productId) => {
            const product = allProducts.find(p => p.id === productId);
            const modal = document.getElementById('admin-variant-modal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
            modal.innerHTML = `<div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 rounded-lg shadow-xl w-full max-w-3xl p-8 relative no-scrollbar overflow-y-auto max-h-screen"><p>Loading variants...</p></div>`;
            
            const variantsRef = collection(db, `products/${productId}/variants`);
            const variantSnapshot = await getDocs(variantsRef);
            const variants = variantSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            modal.innerHTML = `
                <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-700 rounded-lg shadow-xl w-full max-w-3xl p-8 relative no-scrollbar overflow-y-auto max-h-screen">
                    <button id="close-variant-modal" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
                    <h2 class="text-2xl font-bold text-cyan-400 mb-2">Manage Variants for ${product.name}</h2>
                    <p class="text-slate-400 mb-6">Add available sizes, flavors, and prices for this product.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">Add New Variant</h3>
                            <form id="add-variant-form" class="space-y-4">
                                <input type="hidden" id="variantProductId" value="${productId}">
                                <div><label class="block text-sm text-slate-300">Size</label><input type="text" id="variantSize" placeholder="e.g., 1kg" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required></div>
                                <div><label class="block text-sm text-slate-300">Flavour</label><input type="text" id="variantFlavour" placeholder="e.g., Chocolate" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required></div>
                                <div><label class="block text-sm text-slate-300">Price (₹)</label><input type="number" id="variantPrice" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required></div>
                                <div><label class="block text-sm text-slate-300">Sale Price (₹) (Optional)</label><input type="number" id="variantSalePrice" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2"></div>
                                <div><label class="block text-sm text-slate-300">Quantity in Stock</label><input type="number" id="variantQuantity" class="mt-1 w-full bg-slate-700 rounded-md text-white px-3 py-2" required></div>
                                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 font-bold py-2 px-4 rounded-lg">Add Variant</button>
                            </form>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">Existing Variants</h3>
                            <div id="variant-list" class="space-y-3 max-h-96 overflow-y-auto no-scrollbar">
                                ${variants.length > 0 ? variants.map(v => `
                                    <div class="bg-slate-700 p-3 rounded-lg flex justify-between items-center">
                                        <div><p class="font-semibold">${v.size} - ${v.flavour}</p><p class="text-sm text-slate-300">₹${v.price} ${v.salePrice ? `(Sale: ₹${v.salePrice})` : ''} - <span class="${v.quantity > 0 ? 'text-green-400' : 'text-red-400'}">${v.quantity} in stock</span></p></div>
                                        <button data-product-id="${productId}" data-variant-id="${v.id}" class="delete-variant-btn text-red-400 hover:text-red-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                                    </div>`).join('') : '<p class="text-slate-400">No variants added yet.</p>'}
                            </div>
                        </div>
                    </div>
                </div>`;
            lucide.createIcons();
        };
        const closeAdminVariantModal = () => document.getElementById('admin-variant-modal').classList.add('hidden');

        // --- ORDER MANAGEMENT ---
        const handlePayment = async (e) => { 
            const payButton = e.target.querySelector('#pay-button');
            payButton.disabled = true;
            payButton.textContent = 'Processing...';
            showLoading(true);

            e.preventDefault();
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
            let address = "In-Store Pickup";
            if (deliveryType === 'delivery') {
                address = `${document.getElementById('customerAddress1').value}, ${document.getElementById('customerAddress2').value || ''}, ${document.getElementById('customerCity').value}, ${document.getElementById('customerState').value} - ${document.getElementById('customerPincode').value}`;
            }

            const customerDetails = { 
                name: document.getElementById('customerName').value, email: document.getElementById('customerEmail').value.trim().toLowerCase(), phone: document.getElementById('customerPhone').value,
                address: address,
                userId: currentUser ? currentUser.uid : 'guest'
            }; 
            
            if (deliveryType === 'delivery' && liveLocationData) {
                customerDetails.liveLocation = liveLocationData;
            }

            const totalAmount = parseFloat(DOMElements.cartTotal.textContent.replace('₹', '').replace(/,/g, '')); 
            
            const placeOrder = async (paymentDetails = {}) => {
                 try { 
                    await runTransaction(db, async (transaction) => { 
                        for (const item of cart) { 
                            const variantRef = doc(db, `products/${item.productId}/variants`, item.variantId); 
                            const variantDoc = await transaction.get(variantRef); 
                            if (!variantDoc.exists()) throw "Variant not found!"; 
                            const newQuantity = variantDoc.data().quantity - item.quantity; 
                            if (newQuantity < 0) throw `Not enough stock for ${item.name}`; 
                            transaction.update(variantRef, { quantity: newQuantity }); 
                        } 
                        const orderRef = doc(collection(db, 'orders')); 
                        const orderItems = cart.map(item => ({ name: item.name, quantity: item.quantity, price: item.price, salePrice: item.salePrice, size: item.size, flavour: item.flavour })); 
                        transaction.set(orderRef, { 
                            ...paymentDetails, customer: customerDetails, items: orderItems, total: totalAmount, couponUsed: appliedCoupon ? appliedCoupon.id : null, status: 'Pending', deliveryType: deliveryType, timestamp: serverTimestamp() 
                        }); 
                    }); 
                    showToast(`Order placed successfully!`); cart = []; appliedCoupon = null; liveLocationData = null; updateCart(); closeCheckout(); 
                } catch (err) { console.error("Transaction failed: ", err); showToast(`Order failed: ${err.message || err}`, true); } 
                finally { showLoading(false); }
            };

            if (paymentMethod === 'cod') {
                placeOrder({ paymentMethod: 'cod', paymentStatus: 'unpaid' });
            } else {
                 const options = { 
                    "key": "YOUR_RAZORPAY_KEY_ID", // IMPORTANT: Replace with your actual key
                    "amount": totalAmount * 100, 
                    "currency": "INR", "name": "Ajay's Nutrition", "description": "Order Payment", "image": "https://placehold.co/100x100/0f172a/FFFFFF?text=AN", 
                    "handler": (response) => { 
                        placeOrder({ razorpayPaymentId: response.razorpay_payment_id, paymentMethod: 'razorpay', paymentStatus: 'paid' });
                    }, 
                    "prefill": { "name": customerDetails.name, "email": customerDetails.email, "contact": customerDetails.phone }, 
                    "theme": { "color": "#06b6d4" },
                    "modal": { "ondismiss": () => { showLoading(false); payButton.disabled = false; payButton.textContent = 'Pay Securely'; } }
                };
                if (options.key === "YOUR_RAZORPAY_KEY_ID") {
                    showToast('Payment gateway is not configured.', true);
                    showLoading(false);
                    payButton.disabled = false;
                    payButton.textContent = 'Pay Securely';
                    return;
                }
                const rzp1 = new Razorpay(options); 
                rzp1.on('payment.failed', (response) => { showToast(`Payment failed: ${response.error.description}`, true); showLoading(false); payButton.disabled = false; payButton.textContent = 'Pay Securely'; }); 
                rzp1.open(); 
            }
        };
        const handleCustomerLookup = async () => { const lookupError = document.getElementById('customer-lookup-error'); lookupError.classList.add('hidden'); const email = document.getElementById('customerLookupEmail').value.trim().toLowerCase(); if (!email) return; try { const q = query(ordersCollection, where("customer.email", "==", email)); const querySnapshot = await getDocs(q); let orders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); orders.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)); if (orders.length > 0) { renderCustomerOrders(orders); DOMElements.customerLookupScreen.classList.add('hidden'); DOMElements.customerOrdersScreen.classList.remove('hidden'); } else { lookupError.classList.remove('hidden'); } } catch (error) { console.error("Error looking up orders:", error); showToast('Could not fetch orders.', true); } };

        // --- EVENT LISTENERS (Using Delegation for dynamic content) ---
        const setupEventListeners = () => {
            document.getElementById('admin-login-link').addEventListener('click', (e) => { e.preventDefault(); switchView('admin-view'); });
            document.getElementById('my-orders-link').addEventListener('click', e => { e.preventDefault(); switchView('customer-view'); });
            document.getElementById('mobile-my-orders-link').addEventListener('click', e => { e.preventDefault(); switchView('customer-view'); DOMElements.mobileMenu.classList.add('hidden'); });
            
            [...document.querySelectorAll('[id^="back-to-shop-"]')].forEach(btn => btn.addEventListener('click', () => switchView('shop-view')));
            document.getElementById('customer-lookup-form').addEventListener('submit', (e) => { e.preventDefault(); handleCustomerLookup(); });
            document.getElementById('back-to-products-grid').addEventListener('click', () => switchView('shop-view'));
            document.getElementById('lookup-another-email-btn').addEventListener('click', () => { DOMElements.customerOrdersScreen.classList.add('hidden'); DOMElements.customerLookupScreen.classList.remove('hidden'); document.getElementById('customerLookupEmail').value = ''; document.getElementById('customer-lookup-error').classList.add('hidden'); });
            
            document.getElementById('login-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                if (document.getElementById('password').value === 'AjayAdmin@2024!') { 
                    sessionStorage.setItem('isAdminLoggedIn', 'true'); 
                    showDashboard(); 
                    setupAdminOrdersListener();
                    setupAdminDailyOrdersListener();
                } else { document.getElementById('login-error').classList.remove('hidden'); } 
            });
            document.getElementById('logout-button').addEventListener('click', () => { sessionStorage.removeItem('isAdminLoggedIn'); document.getElementById('password').value = ''; showLoginScreen(); detachAdminOrdersListener(); });
            document.getElementById('add-new-product-btn').addEventListener('click', () => openAdminProductModal());
            document.getElementById('add-coupon-form').addEventListener('submit', e => { e.preventDefault(); const couponData = { code: document.getElementById('couponCode').value, discountType: document.getElementById('discountType').value, value: document.getElementById('discountValue').value, }; saveCoupon(couponData); e.target.reset(); });
            
            document.getElementById('cart-button').addEventListener('click', openCart);
            document.getElementById('close-cart-button').addEventListener('click', closeCart);
            document.getElementById('cart-overlay').addEventListener('click', closeCart);
            document.getElementById('checkout-button').addEventListener('click', () => { closeCart(); openCheckout(); });
            
            DOMElements.cartItemsContainer.addEventListener('click', (e) => { const qBtn = e.target.closest('.quantity-change'); const rBtn = e.target.closest('.remove-item'); if (qBtn) changeQuantity(qBtn.dataset.id, parseInt(qBtn.dataset.change)); if (rBtn) removeFromCart(rBtn.dataset.id); });
            document.getElementById('apply-coupon-btn').addEventListener('click', applyCoupon);
            document.getElementById('mobile-menu-button').addEventListener('click', () => DOMElements.mobileMenu.classList.toggle('hidden'));
            document.querySelectorAll('.mobile-menu-link').forEach(link => link.addEventListener('click', () => DOMElements.mobileMenu.classList.add('hidden')));
            DOMElements.categoryFilters.addEventListener('click', (e) => { const btn = e.target.closest('.category-btn'); if(btn) { currentPage = 1; document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentCategory = btn.dataset.category; filterAndRenderProducts(); } });
            
            const handleSearch = (e) => { currentPage = 1; currentSearchTerm = e.target.value.toLowerCase(); filterAndRenderProducts(); };
            DOMElements.searchBar.addEventListener('keyup', handleSearch);
            DOMElements.mobileSearchBar.addEventListener('keyup', handleSearch);
            
            document.getElementById('sort-by-select').addEventListener('change', e => { currentPage = 1; currentSort = e.target.value; filterAndRenderProducts(); });
            document.getElementById('brand-filter').addEventListener('change', e => { currentPage = 1; currentBrand = e.target.value; filterAndRenderProducts(); });
            document.getElementById('goal-filter').addEventListener('change', e => { currentPage = 1; currentGoal = e.target.value; filterAndRenderProducts(); });
            document.getElementById('newsletter-form').addEventListener('submit', e => { e.preventDefault(); const email = document.getElementById('newsletter-email').value.trim().toLowerCase(); if(email) { subscribeToNewsletter(email); e.target.reset(); } });
            
            ['dashboard', 'products', 'orders', 'daily-orders', 'coupons', 'settings', 'subscribers'].forEach(t => document.getElementById(`tab-${t}`).addEventListener('click', () => switchAdminTab(t)));
            
            document.getElementById('settings-form').addEventListener('submit', e => { e.preventDefault(); const settings = { enabled: document.getElementById('bannerEnabled').checked, message: document.getElementById('bannerMessage').value }; saveBannerSettings(settings); });
            
            // --- EVENT DELEGATION FOR DYNAMIC CONTENT ---
            document.body.addEventListener('click', async (e) => {
                // Admin Product List actions
                if (e.target.closest('#admin-product-list')) {
                    const deleteBtn = e.target.closest('.delete-product-btn');
                    const editBtn = e.target.closest('.edit-product-btn');
                    const variantsBtn = e.target.closest('.manage-variants-btn');
                    if (deleteBtn) { if (await confirmAction({ title: 'Delete Product?', text: 'This will delete the product and ALL its variants permanently.' })) deleteProduct(deleteBtn.dataset.id); }
                    if (editBtn) { const product = allProducts.find(p => p.id === editBtn.dataset.id); openAdminProductModal(product); }
                    if (variantsBtn) { openAdminVariantModal(variantsBtn.dataset.id); }
                }

                // Admin Coupon List actions
                const couponDeleteBtn = e.target.closest('.delete-coupon-btn');
                if (couponDeleteBtn) { if(await confirmAction({title: 'Delete Coupon?', text: `Are you sure you want to delete ${couponDeleteBtn.dataset.id}?`})) deleteCoupon(couponDeleteBtn.dataset.id); }
                
                // Image remove button in product modal
                const removeImageBtn = e.target.closest('.remove-image-btn');
                if (removeImageBtn) {
                    const fileName = removeImageBtn.dataset.filename;
                    if (fileName) { // It's a file from the upload array
                        imageFilesToUpload = imageFilesToUpload.filter(file => file.name !== fileName);
                    }
                    removeImageBtn.parentElement.remove(); // Remove visually
                }
                
                // Admin Modals Close and variant deletion
                if (e.target.closest('#close-product-modal')) closeAdminProductModal();
                if (e.target.closest('#close-variant-modal')) closeAdminVariantModal();
                const deleteVariantBtn = e.target.closest('.delete-variant-btn');
                if (deleteVariantBtn) {
                     if(await confirmAction({title: 'Delete Variant?', text: `This variant will be permanently deleted.`})) {
                         deleteVariant(deleteVariantBtn.dataset.productId, deleteVariantBtn.dataset.variantId);
                     }
                }
                if (e.target.closest('#close-checkout-button')) closeCheckout();

                // Accordions
                const accordionHeader = e.target.closest('.faq-question, .info-accordion-question');
                if (accordionHeader) {
                    const answer = accordionHeader.nextElementSibling;
                    const icon = accordionHeader.querySelector('.faq-icon, .accordion-icon');
                    if (!answer || !icon) return;
                    const wasOpen = answer.style.maxHeight && answer.style.maxHeight !== '0px';
                    if (!wasOpen) {
                        answer.style.maxHeight = answer.scrollHeight + 'px';
                        icon.style.transform = accordionHeader.classList.contains('faq-question') ? 'rotate(45deg)' : 'rotate(180deg)';
                    } else {
                        answer.style.maxHeight = null;
                        icon.style.transform = 'rotate(0deg)';
                    }
                }
                
                // Product Detail Page actions
                const detailContent = e.target.closest('#product-detail-content');
                if(detailContent) {
                    const sizeBtn = e.target.closest('.size-btn');
                    const thumbnail = e.target.closest('#product-thumbnails img');
                    if (sizeBtn) {
                        const selectedSize = sizeBtn.dataset.size;
                        updateVariantSelectors(selectedSize);
                    }
                    if (thumbnail) {
                        document.getElementById('main-product-image').src = thumbnail.dataset.fullSrc;
                        document.querySelectorAll('#product-thumbnails img').forEach(img => img.classList.replace('border-cyan-500', 'border-slate-700'));
                        thumbnail.classList.replace('border-slate-700', 'border-cyan-500');
                    }
                }
            });

            document.body.addEventListener('change', e => {
                // Admin Order Status Change
                const statusSelect = e.target.closest('.order-status-select');
                if (statusSelect) { updateOrderStatusAndTracking(statusSelect.dataset.id, { status: statusSelect.value }); }

                // Product Detail Flavour Change
                const flavourSelect = e.target.closest('#flavour-selector');
                if (flavourSelect) {
                    const selectedSize = document.querySelector('#size-selector .size-btn.active').dataset.size;
                    updatePriceAndStock(selectedSize, flavourSelect.value);
                }
            });

            document.body.addEventListener('submit', e => {
                // Admin Add/Edit Product
                if (e.target.id === 'add-product-form') {
                    e.preventDefault();
                    showLoading(true);
                    const form = e.target;
                    const selectedGoals = Array.from(form.querySelectorAll('.goal-checkbox:checked')).map(cb => cb.value);
                    
                    const existingImageUrls = Array.from(document.querySelectorAll('#image-preview-container [data-url]'))
                        .map(el => el.dataset.url)
                        .filter(url => !url.startsWith('blob:'));

                    const productData = { name: form.querySelector('#productName').value, brand: form.querySelector('#productBrand').value, description: form.querySelector('#productDescription').value, imageUrls: existingImageUrls, imageUrl: existingImageUrls[0] || '', category: form.querySelector('#productCategory').value, isFeatured: form.querySelector('#productIsFeatured').checked, goals: selectedGoals, pricePerServing: form.querySelector('#productPricePerServing').value, form: form.querySelector('#productForm').value, packaging: form.querySelector('#productPackaging').value, benefits: form.querySelector('#productBenefits').value.split(',').map(b=>b.trim()).filter(Boolean), usageInfo: form.querySelector('#productUsageInfo').value, ingredients: form.querySelector('#productIngredients').value, manufacturerInfo: form.querySelector('#productManufacturerInfo').value, additionalInfo: form.querySelector('#productAdditionalInfo').value, disclaimer: form.querySelector('#productDisclaimer').value };
                    saveProduct(productData, form.querySelector('#productId').value);
                }
                // Admin Add Variant
                if (e.target.id === 'add-variant-form') {
                    e.preventDefault();
                    const form = e.target;
                    const variantData = { size: form.querySelector('#variantSize').value, flavour: form.querySelector('#variantFlavour').value, price: form.querySelector('#variantPrice').value, salePrice: form.querySelector('#variantSalePrice').value, quantity: form.querySelector('#variantQuantity').value };
                    saveVariant(form.querySelector('#variantProductId').value, variantData);
                    form.reset();
                }
                // Add Review
                if (e.target.id === 'add-review-form') {
                    e.preventDefault();
                    const form = e.target;
                    const reviewData = { authorName: form.querySelector('#reviewAuthor').value, text: form.querySelector('#reviewText').value, rating: Number(form.querySelector('input[name="rating"]:checked').value), timestamp: serverTimestamp() };
                    addReview(form.querySelector('#reviewProductId').value, reviewData); 
                    form.reset();
                }
                // Checkout Form
                if (e.target.id === 'checkout-form') {
                    e.preventDefault();
                    handlePayment(e);
                }
            });
        };

        // --- INITIALIZATION LOGIC ---
        const setupScrollAnimations = () => {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));
        };
        
        window.addEventListener('scroll', () => {
             if (window.scrollY > 300) {
                DOMElements.scrollToTopBtn.classList.remove('opacity-0', 'translate-y-20');
            } else {
                DOMElements.scrollToTopBtn.classList.add('opacity-0', 'translate-y-20');
            }
        });
        DOMElements.scrollToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

        document.addEventListener('DOMContentLoaded', async () => {
             try {
                lucide.createIcons();
                renderSkeletons();
                updateCart();
                switchView('shop-view');
                setupEventListeners();
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                
                productsCollection = collection(db, "products");
                ordersCollection = collection(db, "orders");
                couponsCollection = collection(db, "coupons");
                settingsCollection = collection(db, "site_settings");
                subscribersCollection = collection(db, "subscribers");
                usersCollection = collection(db, "users");
                wishlistsCollection = collection(db, "wishlists");


                onSnapshot(doc(db, 'site_settings', 'banner'), (docSnap) => {
                    const banner = document.getElementById('promotional-banner');
                    const bannerText = document.getElementById('banner-text-content');
                    const bannerTextClone = document.getElementById('banner-text-content-clone');
                    const settingsForm = document.getElementById('settings-form');
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.enabled && data.message) {
                            bannerText.textContent = data.message;
                            bannerTextClone.textContent = data.message;
                            banner.classList.remove('hidden');
                        } else { banner.classList.add('hidden'); }
                        if (settingsForm) {
                            document.getElementById('bannerEnabled').checked = data.enabled || false;
                            document.getElementById('bannerMessage').value = data.message || '';
                        }
                    }
                });
                
                await signInAnonymously(auth);
                onAuthStateChanged(auth, user => { if (user) currentUser = user; });

                onSnapshot(query(productsCollection, orderBy("name")), async (snapshot) => {
                    const productPromises = snapshot.docs.map(async (pDoc) => {
                        const productData = { id: pDoc.id, ...pDoc.data() };
                        const variantsRef = collection(db, `products/${pDoc.id}/variants`);
                        const vSnap = await getDocs(query(variantsRef));
                        productData.minPrice = vSnap.empty ? null : Math.min(...vSnap.docs.map(d => d.data().salePrice || d.data().price));
                        productData.hasSale = vSnap.docs.some(d => d.data().salePrice);
                        productData.totalStock = vSnap.docs.reduce((acc, doc) => acc + (doc.data().quantity || 0), 0);
                        productData.variantCount = vSnap.size;
                        const reviewsRef = collection(db, `products/${pDoc.id}/reviews`);
                        const rSnap = await getDocs(reviewsRef);
                        productData.avgRating = rSnap.empty ? 0 : rSnap.docs.reduce((acc, r) => acc + r.data().rating, 0) / rSnap.size;
                        return productData;
                    });
                    allProducts = await Promise.all(productPromises);
                    filterAndRenderProducts();
                    renderAdminProducts(allProducts);
                    renderCategoryCards();
                    renderCategoryFilters();
                    renderAdvancedFilters();
                    calculateDashboardStats(allOrders, allProducts);
                    setTimeout(setupScrollAnimations, 100); // Allow products to render first
                });

                onSnapshot(query(couponsCollection), (snapshot) => renderAdminCoupons(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                onSnapshot(query(subscribersCollection, orderBy("subscribedAt", "desc")), (snapshot) => renderAdminSubscribers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                onSnapshot(query(usersCollection), (snapshot) => {
                    allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                });


                if (sessionStorage.getItem('isAdminLoggedIn') === 'true') { 
                    showDashboard(); 
                    setupAdminOrdersListener();
                    setupAdminDailyOrdersListener();
                } else { 
                    showLoginScreen(); 
                }

            } catch (error) {
                console.error("A critical error occurred during initialization:", error);
                document.body.innerHTML = `<div class="bg-slate-900 text-white min-h-screen flex items-center justify-center p-4"><div class="text-center"><h1 class="text-2xl font-bold text-red-500 mb-4">Oops! Something went wrong.</h1><p class="text-slate-300">The application failed to load. Please try refreshing the page.</p><p class="mt-4 text-xs text-slate-500">Error details: ${error.message}</p></div></div>`;
            }
        });
    </script>
</body>
</html>
